"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[1462],{3753:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var s=t(46376),r=t(25105),a=t(89999);const o={slug:"wechatminiapp-login-get-use-info",title:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u548c\u83b7\u53d6\u4fe1\u606f\u529f\u80fd\u8bb0\u5f55",date:new Date("2024-10-07T21:10:15.000Z"),authors:"yuluo",tags:["Unipp","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f","Vue3"],keywords:["login","getUserInfo","Unipp","Vue3","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f"]},i=void 0,l={authorsImageUrls:[void 0]},c=[{value:"\u80cc\u666f\u9700\u6c42",id:"\u80cc\u666f\u9700\u6c42",level:2},{value:"\u5c0f\u7a0b\u5e8f\u524d\u53f0",id:"\u5c0f\u7a0b\u5e8f\u524d\u53f0",level:2},{value:"Spring Boot \u540e\u53f0\u903b\u8f91",id:"spring-boot-\u540e\u53f0\u903b\u8f91",level:2},{value:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u7528\u6237\u767b\u5f55\u63a5\u53e3",id:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u7528\u6237\u767b\u5f55\u63a5\u53e3",level:3},{value:"\u83b7\u53d6\u7528\u6237\u624b\u673a\u53f7\u63a5\u53e3",id:"\u83b7\u53d6\u7528\u6237\u624b\u673a\u53f7\u63a5\u53e3",level:3}];function p(n){const e={code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,a.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h2,{id:"\u80cc\u666f\u9700\u6c42",children:"\u80cc\u666f\u9700\u6c42"}),"\n",(0,r.jsx)(e.p,{children:"\u5c0f\u7a0b\u5e8f\u7528\u6237\u8fdb\u5165\u5c0f\u7a0b\u5e8f\uff0c\u5224\u65ad\u7528\u6237\u672a\u767b\u5f55\u5219\u8df3\u8f6c\u81f3\u767b\u5f55\u72b6\u6001\u8fdb\u884c\u767b\u5f55\u64cd\u4f5c\uff0c\u767b\u5f55\u65f6\u540e\u5982\u679c\u540e\u53f0\u6ca1\u6709\u76f8\u5173\u4fe1\u606f\uff0c\u5219\u8df3\u8f6c\u81f3\u83b7\u53d6\u4fe1\u606f\u4fe1\u606f\u9875\u9762\u83b7\u53d6\u4e4b\u540e\u518d\u8fdb\u884c\u767b\u5f55\u3002"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.img,{alt:"img",src:t(51286).A+"",width:"710",height:"720"})}),"\n",(0,r.jsx)(e.h2,{id:"\u5c0f\u7a0b\u5e8f\u524d\u53f0",children:"\u5c0f\u7a0b\u5e8f\u524d\u53f0"}),"\n",(0,r.jsx)(e.p,{children:"\u68c0\u6d4b\u7528\u6237\u662f\u5426\u767b\u5f55\uff0c\u6211\u5c06\u7528\u6237\u4fe1\u606f\u5b58\u5230\u4e86 storage \u4e2d\uff0c\u4ee5\u6b64\u6765\u5224\u65ad\uff0c\u5728 onMounted \u4e2d\u8c03\u7528\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ts",children:'const checkUserLogin = () => {\n  if (uni.getStorageSync("user") === "") {\n    uni.redirectTo({ url: \'login\' })\n  } else {\n    console.log(uni.getStorageSync("user"));\n  }\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u7528\u6237\u6ca1\u6709\u767b\u5f55\uff0c\u5219\u8df3\u8f6c\u81f3\u767b\u5f55\u9875\u9762\u3002\u767b\u5f55\u9875\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-html",children:'<view>\n    <up-button open-type="get" @click="userLogin()" type="primary" size="normal" shape="circle" text="\u767b\u5f55"\n               :hairline="true"></up-button>\n</view>\n\n// script\nconst userLogin = () => {\n\n // \u4f7f\u7528 uniapp \u7684\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u63a5\u53e3\n    uni.login({\n        "provider": "weixin",\n        // \u5fae\u4fe1\u767b\u5f55\u4ec5\u8bf7\u6c42\u6388\u6743\u8ba4\u8bc1\n        "onlyAuthorize": true,\n        success: function (event) {\n            const { code } = event\n            console.log("weixin code: ", code);\n   \n   // \u6839\u636e\u9879\u76ee\u9700\u6c42\uff0c\u81ea\u5b9a\u4e49\u7684\u4e1a\u52a1\u903b\u8f91\n            if (uni.getStorageSync("dbFlag") && uni.getStorageSync("userData")) {\n                const userData = uni.getStorageSync("userData")\n                wxUserLogin({\n                    code: code,\n                    phone: userData.phone,\n                    nickName: userData.nickName,\n                    avatar: userData.avatar\n                }).then((res: any) => {\n                    if (res.statusCode === 200) {\n                        if (res.data.code === ResponseCode.Success) {\n                            // \u8bbe\u7f6e\u767b\u5f55\u6001\n                            currentUser.value = res.data.data\n                            let user: UserAuth = {}\n                            user.token = currentUser.value.token\n                            user.type = Number(currentUser.value.type)\n                            user.userId = currentUser.value.id\n\n                            uni.removeStorageSync("user")\n                            uni.setStorageSync("user", JSON.stringify(user))\n                            uni.removeStorageSync("userData")\n                            uni.removeStorageSync("dbFlag")\n\n                            uni.redirectTo({\n                                url: "index"\n                            })\n                        } else {\n                            uni.showModal({\n                                title: \'\u767b\u5f55\u5931\u8d25\',\n                                content: "\u767b\u5f55\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u91cd\u8bd5",\n                                success(res) {\n                                    if (res.confirm) {\n                                    } else if (res.cancel) {\n                                    }\n                                }\n                            })\n                        }\n                    } else {\n                        uni.showModal({\n                            title: \'\u767b\u5f55\u5931\u8d25\',\n                            content: res.message,\n                            success(res) {\n                                if (res.confirm) {\n                                    // \u518d\u6b21\u5c1d\u8bd5\u767b\u5f55\n                                    userLogin()\n                                } else if (res.cancel) {\n                                }\n                            }\n                        })\n                    }\n                })\n            } else {\n                wxUserLogin({\n                    code: code\n                }).then((res: any) => {\n                    if (res.statusCode === 200) {\n                        if (res.data.code === ResponseCode.Success) {\n                            if (res.data.data.dbFlag == 1) {\n                                // \u8868\u660e\u5f53\u524d\u767b\u5f55\u7684\u7528\u6237\u5728\u540e\u53f0\u6570\u636e\u5e93\u4e2d\u6ca1\u6709\u5bf9\u5e94\u7684\u7528\u6237\u6635\u79f0\n                                // \u7b49\u4fe1\u606f\uff0c\u9700\u8981\u83b7\u53d6\u4fdd\u5b58\u5230\u6570\u636e\u5e93\u4e2d\u3002\n                                uni.setStorageSync("dbFlag", res.data.data.dbFlag)\n                                setUserInfo()\n                                console.log("\u540e\u53f0\u6570\u636e\u5e93\u4e2d\u6ca1\u6709\u7528\u6237\u4fe1\u606f\uff0c\u8df3\u8f6c\u81f3\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u9875\uff01");\n                                return\n                            }\n\n                            // \u8bbe\u7f6e\u767b\u5f55\u6001\n                            currentUser.value = res.data.data\n                            let user: UserAuth = {}\n                            user.token = currentUser.value.token\n                            user.type = Number(currentUser.value.type)\n                            user.userId = currentUser.value.id\n\n                            uni.removeStorageSync("user")\n                            uni.setStorageSync("user", JSON.stringify(user))\n\n                            uni.redirectTo({\n                                url: "index"\n                            })\n                        } else {\n                            uni.showModal({\n                                title: \'\u767b\u5f55\u5931\u8d25\',\n                                content: "\u767b\u5f55\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u91cd\u8bd5",\n                                success(res) {\n                                    if (res.confirm) {\n                                        // \u518d\u6b21\u5c1d\u8bd5\u767b\u5f55\n                                        userLogin()\n                                    } else if (res.cancel) {\n                                    }\n                                }\n                            })\n                        }\n                    } else {\n                        uni.showModal({\n                            title: \'\u767b\u5f55\u5931\u8d25\',\n                            content: res.message,\n                            success(res) {\n                                if (res.confirm) {\n                                    // \u518d\u6b21\u5c1d\u8bd5\u767b\u5f55\n                                    userLogin()\n                                } else if (res.cancel) {\n                                }\n                            }\n                        })\n                    }\n                })\n            }\n        },\n        fail: function (err) {\n            console.log("\u5fae\u4fe1\u767b\u5f55\u5931\u8d25\uff1a", err);\n        }\n    })\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u5982\u679c\u540e\u53f0\u6570\u636e\u5e93\u4e2d\u6ca1\u6709\u7528\u6237\u7684\u8eab\u4efd\u4fe1\u606f\uff0c\u5219\u8fd4\u56de\u7684\u6807\u5fd7\u4f4d\u4e3a 1 \uff0c\u5c0f\u7a0b\u5e8f\u8df3\u8f6c\u5230\u83b7\u53d6\u7528\u6237\u8eab\u4efd\u4fe1\u606f\u7684\u9875\u9762\uff0c\u8fdb\u884c\u83b7\u53d6\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ts",children:"// \u7528\u6237\u5728\u767b\u5f55\u4e4b\u540e\uff0c\u9700\u8981\u83b7\u53d6\u7528\u6237\u7684\u6635\u79f0\u548c\u5934\u50cf\u4fe1\u606f\u7528\u4e8e\u5c55\u793a\nconst setUserInfo = () => {\n    uni.redirectTo({ url: 'getUserInfo' })\n}\n"})}),"\n",(0,r.jsx)(e.p,{children:"\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u7684 vue \u9875\u9762\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-vue",children:'<template>\n    <up-navbar leftIconColor="#f5f5f5" :placeholder="true" :safeAreaInsetTop="true" title="\u83b7\u53d6\u7528\u6237\u5934\u50cf\u6635\u79f0" :autoBack="true">\n    </up-navbar>\n    <up-toast ref="uToastRef"></up-toast>\n    <view class="containar">\n        <view class="index">\n            <view class="avatarUrl">\n                <button open-type="chooseAvatar" @chooseavatar="onChooseavatar">\n                    <image :src="avatarUrl" class="refreshIcon"></image>\n                </button>\n            </view>\n            <view class="userName">\n                <text>\u6635\u79f0\uff1a</text>\n                <input :clearable="false" type="nickname" class="weui-input" :value="userName" @blur="bindblur"\n                    placeholder="\u8bf7\u9009\u62e9\u6216\u8f93\u5165\u6635\u79f0" @input="bindinput" />\n            </view>\n            <view class="userPhone">\n                <text>\u624b\u673a\u53f7\uff1a</text>\n                <up-button class="phone" type="success" open-type="getPhoneNumber"\n                    @getphonenumber="getPhoneNumber">\u83b7\u53d6\u624b\u673a\u53f7</up-button>\n            </view>\n        </view>\n\n        <view style="width: 100%;height: 1px; background: #EEE;">\n\n        </view>\n        <view class="tips_1" style="width: 700rpx; height: 20px; font-size: 13px; margin: auto; margin-top: 40rpx;">\n            \xb7 \u7533\u8bf7\u83b7\u53d6\u4ee5\u4e0b\u6743\u9650\n        </view>\n        <view class="tips">\n            \xb7 \u83b7\u5f97\u4f60\u7684\u4fe1\u606f\uff08\u6635\u79f0\u3001\u5934\u50cf\u3001\u624b\u673a\u53f7\u7b49\uff09\n        </view>\n\n        <view>\n            <br>\n            <up-button @click="onSubmit" type="primary">\u4fdd\u5b58</up-button>\n        </view>\n    </view>\n</template>\n\n<script lang="ts" setup>\nimport { ResponseCode } from "@/types";\nimport { getUserPhone } from "../alova/service"\nimport { BASE_URL } from \'@/config\';\n\nconst avatarUrl = ref<any>()\nconst userName = ref<string>(\'\')\nconst avatarPath = ref<string>(\'\')\nconst userPhone = ref<string>(\'\')\nconst uToastRef = ref(null)\nconst list = ref([\n    {\n        type: \'success\',\n        position: \'top\',\n        icon: false,\n        duration: 3000,\n        message: "\u5c0f\u7a0b\u5e8f\u68c0\u6d4b\u5230\u6ca1\u6709\u60a8\u7684\u7528\u6237\u4fe1\u606f\uff0c\u8bf7\u4f9d\u6b21\u70b9\u51fb\u4e0b\u65b9\u5934\u50cf\u548c\u6635\u79f0\u4ee5\u83b7\u53d6\uff01"\n    }\n])\n\nonReady(() => {\n    showToast(list.value[0])\n})\n\n// \u65b9\u6cd5\nconst showToast = (params: any) => {\n    uToastRef.value.show({\n        ...params,\n        complete() {\n            params.url && uni.navigateTo({\n                url: params.url\n            });\n        }\n    });\n}\n\nconst getPhoneNumber = (e: any) => {\n\n    console.log("\u5fae\u4fe1\u83b7\u53d6\u7535\u8bdd\u53f7\u7801\u7684 code: ", e.detail.code);\n\n    uni.login({\n        provider: \'weixin\',\n        success: (_: any) => {\n            // \u8c03\u7528\u540e\u7aef\u63a5\u53e3\u83b7\u53d6\u7528\u6237\u624b\u673a\u53f7\u7801\n            getUserPhone({ code: e.detail.code }).then((res: any) => {\n                if (res.data.code === ResponseCode.Success) {\n                    const data = JSON.parse(res.data.data)\n                    // console.log(data);\n                    userPhone.value = data.phone_info.phoneNumber;\n                }\n            })\n        },\n        fail: ((err: any) => {\n            uni.showModal({\n                title: \'\u9519\u8bef\',\n                content: \'\u83b7\u53d6\u7528\u6237\u624b\u673a\u53f7\u5931\u8d25\uff0c err: \' + err,\n                success(res) {\n                    if (res.confirm) {\n                    } else if (res.cancel) {\n                    }\n                }\n            })\n        })\n    });\n\n    // \u624b\u52a8\u8d4b\u503c\uff0cdev \u8df3\u8fc7\u83b7\u53d6\u624b\u673a\u53f7\n    // userPhone.value=\'18198086793\'\n\n}\n\nconst bindblur = (e: any) => {\n    userName.value = e.detail.value;\n}\n\nconst bindinput = (e: any) => {\n    userName.value = e.detail.value;\n}\n\nconst onChooseavatar = (e: any) => {\n\n    avatarUrl.value = e.detail.avatarUrl\n}\n\n/**\n * \u4e0a\u4f20\u5934\u50cf\uff0c\u8fd4\u56de\u5934\u50cf\u7684\u8def\u5f84\u4fe1\u606f\n */\nconst onSubmit = () => {\n\n    if (userName.value == \'\' || userPhone.value == \'\' || avatarUrl.value == \'\') {\n        uni.showModal({\n            title: \'\u4e2a\u4eba\u4fe1\u606f\u672a\u8bbe\u7f6e\',\n            content: \'\u8bf7\u70b9\u51fb\u76f8\u5e94\u9009\u9879\u4ee5\u8bbe\u7f6e\',\n        })\n        return\n    }\n\n    // \u5728\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u5f00\u53d1\u5de5\u5177\u548c\u771f\u673a\u8c03\u8bd5\u4e2d\uff0c\u4e0d\u4f1a\u51fa\u73b0\u95ee\u9898\u3002\u5982\u679c\u5728\u4f53\u9a8c\u7248\u4e2d\uff0c\u9700\u8981\u5728\u5c0f\u7a0b\u5e8f\u540e\u53f0\u8bbe\u7f6e\u4e0a\u4f20\u6587\u4ef6\u57df\u540d\uff0c\u4e0d\u7136\u62a5\u9519\uff01\n    // \u5728\u63d0\u4ea4\u4e2d\uff0c\u5c06\u7528\u6237\u7684\u6635\u79f0\u548c\u5934\u50cf\u4fe1\u606f\u63d0\u4ea4\u5230\u6570\u636e\u5e93\u5b58\u50a8\n    // \u5148\u4e0a\u4f20\u56fe\u7247\u83b7\u5f97 \u56fe\u7247\u8def\u5f84\n    uni.uploadFile({\n        url: BASE_URL + \'upload/avatar\',\n        filePath: avatarUrl.value,\n        name: \'file\',\n        success: function (res) {\n            let resp = JSON.parse(res.data)\n            avatarPath.value = resp.data\n\n            // \u4fdd\u5b58\u7528\u6237\u4fe1\u606f\n            save()\n        },\n        fail: function (err) {\n            uni.showModal({\n                title: \'\u4e0a\u4f20\u5934\u50cf\u6587\u4ef6\u5931\u8d25\',\n                content: err.errMsg,\n            })\n            console.log(err)\n        }\n    })\n}\n\nconst save = () => {\n\n    const data = {\n        nickName: userName.value,\n        avatar: avatarPath.value,\n        phone: userPhone.value,\n    }\n\n    // \u6682\u65f6\u5b58\u50a8\u5230 storage \u4e2d\uff0c\u5728 login \u4e2d\u4f7f\u7528\n    uni.removeStorageSync("userData")\n    uni.setStorageSync("userData", data)\n\n    // \u8df3\u8f6c\u81f3\u767b\u5f55\u9875\n    uni.redirectTo({\n        url: "login"\n    })\n}\n<\/script>\n\n<style lang="scss" scoped>\n.containar {\n    width: 100vw;\n    height: 100vh;\n    background: #fff;\n    box-sizing: border-box;\n    padding: 0 30rpx;\n\n    .index {\n        display: flex;\n        align-items: center;\n        flex-direction: column;\n    }\n\n    .avatarUrl {\n        padding: 80rpx 0 40rpx;\n        background: #fff;\n\n        button {\n            background: #fff;\n            line-height: 80rpx;\n            height: auto;\n            border: none !important;\n            width: auto;\n            // padding: 20rpx 30rpx;\n            margin: 0;\n            display: flex;\n            border: none;\n            justify-content: center;\n            align-items: center;\n\n            &::after {\n                border: none;\n            }\n\n            .refreshIcon {\n                width: 160rpx;\n                height: 160rpx;\n                border-radius: 50%;\n                background-color: #ccc;\n            }\n\n            .jt {\n                width: 14rpx;\n                height: 28rpx;\n            }\n        }\n    }\n\n    .userName {\n        background: #fff;\n        padding: 20rpx 30rpx 80rpx;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n\n        // set font color\n        color: black;\n\n        .weui-input {\n            width: 110px;\n            padding-left: 60rpx;\n        }\n    }\n\n    .userPhone {\n        display: flex;\n        width: 233px;\n        align-items: center;\n        margin-bottom: 10px;\n\n        // \u89e3\u51b3\u5982\u679c\u7528\u6237\u624b\u673a\u8bbe\u7f6e\u4e86\u9ed1\u6697\u6a21\u5f0f\uff0c\u5b57\u4e0d\u663e\u793a\u7684\u95ee\u9898\n        color: black;\n    }\n}\n\n.tips {\n    width: 700rpx;\n    height: 20px;\n    font-size: 13px;\n    margin: 5px 0 15px 19px;\n    color: #cbcbcb;\n}\n\n.tips_1 {\n    color: black;\n}\n\n::v-deep .u-button {\n    border-radius: 10px !important;\n    width: 160px !important;\n}\n</style>\n'})}),"\n",(0,r.jsx)(e.p,{children:"\u7528\u6237\u70b9\u51fb\u786e\u8ba4\u4e4b\u540e\uff0c\u8df3\u8f6c\u81f3 login \u9875\u9762\uff0c\u5b8c\u6210\u767b\u5f55\u64cd\u4f5c\u3002"}),"\n",(0,r.jsx)(e.h2,{id:"spring-boot-\u540e\u53f0\u903b\u8f91",children:"Spring Boot \u540e\u53f0\u903b\u8f91"}),"\n",(0,r.jsx)(e.h3,{id:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u7528\u6237\u767b\u5f55\u63a5\u53e3",children:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u7528\u6237\u767b\u5f55\u63a5\u53e3"}),"\n",(0,r.jsx)(e.p,{children:"\u5728\u524d\u9762\u7684\u6d41\u7a0b\u56fe\u4e2d\uff0c\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u7684\u767b\u5f55\u64cd\u4f5c\u662f\u5148\u8bf7\u6c42\u5fae\u4fe1\u670d\u52a1\u5668\uff0c\u83b7\u53d6 code\uff0c\u5728\u5c06 code \u4f20\u9012\u81f3\u5e94\u7528\u540e\u53f0\u670d\u52a1\u5668\uff0c\u8bf7\u6c42\u63a5\u53e3\u83b7\u53d6 sessionId \u548c openId \u7b49\u4fe1\u606f\u3002"}),"\n",(0,r.jsx)(e.p,{children:"controller \u4ee3\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@PostMapping("/user/weixin/login")\npublic Result<Map<String, String>> login(@RequestBody User user) {\n\n    log.info("\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u7528\u6237\u767b\u5f55....");\n    Map<String, String> userInfo = garageUserService.weChatLogin(user);\n\n    return Result.success(userInfo);\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"Service \u4ee3\u7801\uff1a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public Map<String, String> weChatLogin(User user) {\n\n    // \u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u901a\u7528\u767b\u5f55\u903b\u8f91\n    String url = GarageConstants.WeChatConstants.baseUrl +\n        "?appid=" +\n        configProperties.getAppId() +\n        "&secret=" +\n        configProperties.getAppSecret() +\n        "&js_code=" +\n        user.getCode() +\n        "&grant_type=authorization_code";\n\n    String resp = restTemplate.getForObject(url, String.class);\n    WxCode2SessionResp wxCode2SessionResp = JsonUtils.fromJson(resp, WxCode2SessionResp.class);\n\n    Map<String, String> res = new HashMap<>();\n    if (Objects.isNull(wxCode2SessionResp) || Objects.isNull(wxCode2SessionResp.getSession_key())) {\n        log.error("\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u5931\u8d25\uff0c\u67e5\u770b\u65e5\u5fd7\uff01\uff01\uff01");\n        throw new ServiceException("\u5fae\u4fe1\u767b\u5f55\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01");\n    }\n\n    // \u4e1a\u52a1\u903b\u8f91\n    // \u6839\u636e openId \u67e5\u8be2\n    int dbFlag;\n    // \u5982\u679c openId \u4e3a\u7a7a\uff0c\u5219\u8bc1\u660e\u7528\u6237\u4ece\u672a\u767b\u9646\u8fc7\uff0c\u5219\u9700\u8981\u8bbe\u7f6e\u7528\u6237\u76f8\u5173\u4fe1\u606f\uff0c\u624b\u673a\u53f7\uff0c\u5934\u50cf\uff0c\u6635\u79f0\u7b49\u3002\n    User openIdUser = this.userMapper.selectOneByQuery(new QueryWrapper().eq(User::getOpenId, wxCode2SessionResp.getOpenid()));\n    if (openIdUser == null) {\n        // \u8bc1\u660e\u7528\u6237\u672a\u767b\u9646\u8fc7\n        if (user.getPhone() == null) {\n            // \u7528\u6237\u672a\u767b\u5f55\u8fc7\uff0c\u540c\u65f6\u4e5f\u6ca1\u6709\u643a\u5e26\u7528\u6237\u4fe1\u606f\uff0c\u5219\u76f4\u63a5\u8fd4\u56de\u3002\n            dbFlag = 1;\n            res.put("dbFlag", dbFlag + "");\n\n        } else {\n            User phoneUser = this.userMapper.selectOneByQuery(new QueryWrapper().eq(User::getPhone, user.getPhone()));\n            if (phoneUser == null) {\n                // \u4e3a\u7528\u6237\uff0c\u63d2\u5165\u6570\u636e\n                var wxUser = new User();\n                wxUser.setId(SnowFlakeIdGenerator.generateId());\n                wxUser.setType(2);\n                wxUser.setAvatar(user.getAvatar());\n                wxUser.setNickName(user.getNickName());\n                wxUser.setOpenId(wxCode2SessionResp.getOpenid());\n\n                this.userMapper.insert(wxUser);\n\n                // \u767b\u5f55\n                StpUtil.login(wxUser.getId());\n                res.put("token", StpUtil.getTokenValue());\n                res.put("id", wxUser.getId() + "");\n                res.put("type", wxUser.getType() + "");\n\n            } else {\n                // \u7ef4\u62a4\u4eba\u5458\uff0c\u66f4\u65b0\u6570\u636e\n                phoneUser.setAvatar(user.getAvatar());\n                phoneUser.setNickName(user.getNickName());\n                phoneUser.setOpenId(wxCode2SessionResp.getOpenid());\n\n                this.userMapper.update(phoneUser);\n\n                // \u767b\u5f55\n                StpUtil.login(phoneUser.getOpenId());\n                res.put("token", StpUtil.getTokenValue());\n                res.put("id", phoneUser.getId() + "");\n                res.put("type", phoneUser.getType() + "");\n\n            }\n        }\n    } else {\n        // \u7528\u6237\u4fe1\u606f\u5df2\u7ecf\u5b58\u5728\uff0c\u76f4\u63a5\u767b\u5f55\n        StpUtil.login(openIdUser.getId());\n        res.put("token", StpUtil.getTokenValue());\n        res.put("id", openIdUser.getId() + "");\n        res.put("type", openIdUser.getType() + "");\n\n    }\n\n    return res;\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"entity \uff1a\u7528\u6765\u63a5\u53d7\u5fae\u4fe1 API \u8fd4\u56de\u7684\u6570\u636e\u4fe1\u606f\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class WxCode2SessionResp {\n\n    // openId \u7528\u6237\u552f\u4e00\u6807\u8bc6\n    private String openid; \n\n    // \u4f1a\u8bdd\u5bc6\u94a5\n    private String session_key; \n\n    // \u7528\u6237\u5728\u5f00\u653e\u5e73\u53f0\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u82e5\u5f53\u524d\u5c0f\u7a0b\u5e8f\u5df2\u7ed1\u5b9a\u5230\u5fae\u4fe1\u5f00\u653e\u5e73\u53f0\u5e10\u53f7\u4e0b\u4f1a\u8fd4\u56de\uff0c\u8be6\u89c1 UnionID \u673a\u5236\u8bf4\u660e\u3002\n    private String unionid;         \n\n    // number \u9519\u8bef\u7801\n    private String errcode;         \n\n    // \u9519\u8bef\u4fe1\u606f\n    private String errmsg;    \n}\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u83b7\u53d6\u7528\u6237\u624b\u673a\u53f7\u63a5\u53e3",children:"\u83b7\u53d6\u7528\u6237\u624b\u673a\u53f7\u63a5\u53e3"}),"\n",(0,r.jsx)(e.p,{children:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u5728\u83b7\u53d6\u7528\u6237\u624b\u673a\u53f7\u65f6\uff0c\u9700\u8981\u5728\u540e\u53f0\u8c03\u7528 API \u63a5\u53e3\u5b8c\u6210"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// controller\n@PostMapping(GarageConstants.WeChatConstants.apiPrefix + "/getPhoneNumber")\npublic Result<String> getPhoneNumber(@RequestBody User user) {\n\n    return Result.success(garageUserService.getPhoneNumber(user));\n}\n\n// service\n@Override\npublic String getPhoneNumber(User user) {\n\n    String accessToken = WeChatMsgHelper.refreshAccessToken(\n            configProperties.getAppId(),\n            configProperties.getAppSecret(),\n            restTemplate);\n\n    // String PhoneBaseUrl = "https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=";\n    String url = GarageConstants.WeChatConstants.PhoneBaseUrl + accessToken;\n    Map<String, String> paramMap = new HashMap<>();\n    paramMap.put("code", user.getCode());\n    String body = JsonUtils.toJson(paramMap);\n\n    HttpHeaders headers = new HttpHeaders();\n    headers.setContentType(MediaType.APPLICATION_JSON);\n    // spring boot 3.x \u4ee5\u4e0a\u5fc5\u987b\u8bbe\u7f6e\uff0c\u4e0d\u7136\u4f1a\u51fa\u73b0 412 \u9519\u8bef\u72b6\u6001\u7801\n    headers.setContentLength(body.getBytes(StandardCharsets.UTF_8).length);\n\n    HttpEntity<String> httpEntity = new HttpEntity<>(body, headers);\n    ResponseEntity<String> response = restTemplate.postForEntity(url, httpEntity, String.class);\n\n    return response.getBody();\n}\n\n// helper\npublic class WeChatMsgHelper {\n\n    private static final Logger logger = LoggerFactory.getLogger(WeChatMsgHelper.class);\n\n    // \u63a8\u9001\u6d88\u606f\u7684\u65f6\u5019\u9700\u8981 accessToken\uff0c\u8fd9\u91cc\u662f\u83b7\u53d6\n    // token\u7684\u65b9\u6cd5\uff0c\u5728\u5b9e\u9645\u73af\u5883\u4e2d\uff0c\u4e00\u822c\u662f\u5b9a\u65f6\u5237\u65b0\uff0c\n    // \u4e24\u4e2a\u5c0f\u65f6\u5185\u6709\u6548\uff0c\u83b7\u53d6accesstoken\u65f6\u9700\u8981appid\u548csecret\u4fe1\u606f\uff0c\u4e00\u822c\u662f\u540e\u53f0\u53c2\u6570\u6216\u5e38\u91cf\u8fdb\u884c\u914d\u7f6e\n    // \u83b7\u53d6 accessToken \u7684\u8bf7\u6c42\u63a5\u53e3\n    // String TokenBaseUrl = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential";\n    private final static String GetAccessToken = GarageConstants.WeChatConstants.TokenBaseUrl + "&appid={appid}&secret={secret}";\n\n    public static String refreshAccessToken(String appid, String secret, RestTemplate restTemplate){\n\n        if(!StringUtils.hasText(appid) || !StringUtils.hasText(secret)){\n            logger.error("\u5237\u65b0\u5fae\u4fe1 AccessToken \u65f6\uff0c\u7f3a\u5c11 appid \u6216 secret \u53c2\u6570\uff01");\n            throw new ServiceException("\u5237\u65b0\u5fae\u4fe1 AccessToken \u65f6\uff0c\u7f3a\u5c11 appid \u6216 secret \u53c2\u6570\uff01");\n        }\n\n        Map<String, Object> param = new HashMap<>();\n        param.put("appid",appid);\n        param.put("secret",secret);\n\n        ResponseEntity<JSONObject> resp = restTemplate.getForEntity(\n                GetAccessToken,\n                JSONObject.class,\n                param\n        );\n\n        JSONObject jsonObj = resp.getBody();\n        String accessToken = null;\n        if(jsonObj != null){\n            accessToken = jsonObj.getStr("access_token");\n        }\n\n        return accessToken;\n    }\n}\n'})})]})}function u(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(p,{...n})}):p(n)}},51286:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/a6dba8d0a0b07e688f3eb741121d1704-929b743adcc4b9c7635030405f09d7d1.jpeg"},89999:(n,e,t)=>{t.d(e,{R:()=>o,x:()=>i});var s=t(58101);const r={},a=s.createContext(r);function o(n){const e=s.useContext(a);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function i(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:o(n.components),s.createElement(a.Provider,{value:e},n.children)}},46376:n=>{n.exports=JSON.parse('{"permalink":"/blog/wechatminiapp-login-get-use-info","editUrl":"https://github.com/yuluo-yx/blog/edit/master/blog/wehchat-app/\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u548c\u83b7\u53d6\u4fe1\u606f\u529f\u80fd\u8bb0\u5f55.md","source":"@site/blog/wehchat-app/\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u548c\u83b7\u53d6\u4fe1\u606f\u529f\u80fd\u8bb0\u5f55.md","title":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u548c\u83b7\u53d6\u4fe1\u606f\u529f\u80fd\u8bb0\u5f55","description":"\u80cc\u666f\u9700\u6c42","date":"2024-10-07T21:10:15.000Z","tags":[{"inline":true,"label":"Unipp","permalink":"/blog/tags/unipp"},{"inline":true,"label":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f","permalink":"/blog/tags/\u5fae\u4fe1\u5c0f\u7a0b\u5e8f"},{"inline":true,"label":"Vue3","permalink":"/blog/tags/vue-3"}],"readingTime":7.823333333333333,"hasTruncateMarker":true,"authors":[{"name":"\u7267\u751f","title":"Java & go developer","url":"https://github.com/yuluo-yx","email":"yuluo08290126@gmail.com","socials":{"x":"https://x.com/yuluo","github":"https://github.com/yuluo-yx"},"imageURL":"https://kuizuo.cn/img/logo.png","key":"yuluo","page":null}],"frontMatter":{"slug":"wechatminiapp-login-get-use-info","title":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u548c\u83b7\u53d6\u4fe1\u606f\u529f\u80fd\u8bb0\u5f55","date":"2024-10-07T21:10:15.000Z","authors":"yuluo","tags":["Unipp","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f","Vue3"],"keywords":["login","getUserInfo","Unipp","Vue3","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f"]},"unlisted":false,"prevItem":{"title":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u63a8\u9001","permalink":"/blog/wechatminiapp-msg-push"},"nextItem":{"title":"Element-plus Upload Debug \u8bb0\u5f55","permalink":"/blog/element-plus-upload-debug"}}')}}]);