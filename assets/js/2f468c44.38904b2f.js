"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[4642],{93522:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var s=t(96687),i=t(25105),a=t(89999);const o={slug:"LLMs-AI-Spring-AI-Alibaba-chat-source",title:"\u5927\u6a21\u578b\u4e13\u680f--Spring AI Alibaba Chat \u6e90\u7801\u5206\u6790",date:new Date("2024-12-08T21:24:56.000Z"),authors:"yuluo",tags:["AI","Spring AI Alibabe","chat"],keywords:["AI","Spring AI Aliabab","chat source"]},l=void 0,r={authorsImageUrls:[void 0]},c=[{value:"Spring AI Chat \u63a5\u53e3\u5b9a\u4e49",id:"spring-ai-chat-\u63a5\u53e3\u5b9a\u4e49",level:2},{value:"ChatModel API",id:"chatmodel-api",level:3},{value:"Options \u5904\u7406",id:"options-\u5904\u7406",level:4},{value:"Call \u548c Stream \u65b9\u6cd5",id:"call-\u548c-stream-\u65b9\u6cd5",level:4},{value:"Function \u5904\u7406",id:"function-\u5904\u7406",level:4},{value:"1. Function \u5b9a\u4e49\u548c LLMs \u611f\u77e5",id:"1-function-\u5b9a\u4e49\u548c-llms-\u611f\u77e5",level:5},{value:"2. Spring AI Functions",id:"2-spring-ai-functions",level:5},{value:"3. Function Call Debug",id:"3-function-call-debug",level:5},{value:"4. \u603b\u7ed3",id:"4-\u603b\u7ed3",level:5},{value:"\u53ef\u89c2\u6d4b",id:"\u53ef\u89c2\u6d4b",level:4},{value:"ChatClient API",id:"chatclient-api",level:3}];function p(n){const e={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.p,{children:"Chat \u529f\u80fd\u662f LLMs \u5e94\u7528\u7684\u6700\u57fa\u7840\u529f\u80fd\uff0c\u4efb\u4f55\u529f\u80fd\u90fd\u8981\u5411 LLMs \u5e94\u7528\u7ed9\u8f93\u5165\uff0c\u4e4b\u540e\u5c06\u83b7\u5f97 LLMs \u7684\u8fd4\u56de\u3002\u5176\u5e95\u5c42\u662f NLP \u7684\u5b9e\u73b0\u3002\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u4e0d\u4f1a\u5206\u6790 LLMs \u7684\u5e95\u5c42\u5b9e\u73b0\uff0c\u4f1a\u5206\u6790\u4e00\u6ce2 Spring AI Albaba \u7684 Chat \u529f\u80fd\u5b9e\u73b0\u548c Spring AI \u63d0\u4f9b\u7684 Chat \u63a5\u53e3\u5b9e\u73b0\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"spring-ai-chat-\u63a5\u53e3\u5b9a\u4e49",children:"Spring AI Chat \u63a5\u53e3\u5b9a\u4e49"}),"\n",(0,i.jsx)(e.p,{children:"\u4ece\u4e4b\u524d\u7684 Spring AI Alibaba \u4f7f\u7528\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cSpring AI \u63d0\u4f9b\u4e86\u4e24\u79cd Chat Model \u7684\u5b9e\u73b0\uff0c\u4e00\u79cd\u662f\u6bd4\u8f83\u4f4e\u7ea7\u7684 ChatModel API\uff0c\u4e00\u79cd\u662f\u9ad8\u7ea7\u7684 ChatClient API\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5176\u4e24\u8005\u7684\u533a\u522b\u662f\uff1aChatModel \u662f\u9488\u5bf9\u4e8e\u5404\u4e2a\u6a21\u578b\u7684\u5ba2\u6237\u7aef\uff0c\u800c ChatClient \u662f\u5c4f\u853d\u5e95\u5c42\u6a21\u578b\u5dee\u5f02\u6027\u7684\u5ba2\u6237\u7aef\u63a5\u53e3\uff0c\u57fa\u4e8e ChatClient\uff0cSpring AI \u63d0\u4f9b\u4e86\u5f3a\u5927\u7684 Advisors \u673a\u5236\u6765\u6269\u5c55\u529f\u80fd\u3002Advisors API \u7684\u5b9e\u73b0\u7c7b\u4f3c\u4e8e Spring \u7684 AOP\uff0c\u5e94\u7528\u4e86 AOP \u7684\u7f16\u7a0b\u601d\u60f3\u3002"}),"\n",(0,i.jsx)(e.h3,{id:"chatmodel-api",children:"ChatModel API"}),"\n",(0,i.jsx)(e.p,{children:"\u4e0b\u9762\u4ee5 Spring AI Alibaba \u7684 DashScope ChatModel \u4e3a\u4f8b\u6765\u4e86\u89e3\u4e00\u4e0b ChatModel \u7684\u6e90\u7801\u8bbe\u8ba1\u3002"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"ChatModel",src:t(34416).A+"",width:"2370",height:"2222"})}),"\n",(0,i.jsx)(e.p,{children:"\u4ece IDEA \u751f\u6210\u7684\u5173\u7cfb\u56fe\u6765\u770b\uff1aDashScopeChatModel \u7ee7\u627f\u4e86 AbstractToolCallSupport \u5b9e\u73b0\u4e86 ChatModel \u63a5\u53e3\u3002\u5176\u4e2d AbstractToolCallSupport \u5b9e\u73b0\u4e86 \u5de5\u5177\u51fd\u6570\u8c03\u7528\u7684 \u62bd\u8c61\u903b\u8f91\uff0cChatModel \u63d0\u4f9b\u4e86 call() \u548c stream() \u65b9\u6cd5\uff0c\u7528\u6765\u548c LLMs \u8fdb\u884c\u4ea4\u4e92\u3002\u4ece\u56db\u4e2a\u7ef4\u5ea6\u6765\u7406\u89e3\u4e00\u4e0b ChatModel \u505a\u7684\u4e8b\u60c5\uff1a"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"Options\uff0c\u6a21\u578b\u914d\u7f6e\u53c2\u6570\u7684\u5904\u7406\uff1b"}),"\n",(0,i.jsx)(e.li,{children:"call \u548c stream \u7684\u8c03\u7528\uff1b"}),"\n",(0,i.jsx)(e.li,{children:"Function \u5904\u7406\uff1b"}),"\n",(0,i.jsx)(e.li,{children:"\u53ef\u89c2\u6d4b\u5904\u7406\u3002"}),"\n"]}),"\n",(0,i.jsx)(e.h4,{id:"options-\u5904\u7406",children:"Options \u5904\u7406"}),"\n",(0,i.jsx)(e.p,{children:"\u5728 Spring AI \u4e2d\uff0c\u5c06\u5927\u6a21\u578b\u7684\u4e00\u4e9b\u53c2\u6570\u62bd\u8c61\u6210\u4e86 Options \u7684\u6982\u5ff5\uff0c\u5176\u7c7b\u7ed3\u6784\u5982\u4e0b\u56fe\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"DashScopeChatOptions",src:t(40665).A+"",width:"918",height:"668"})}),"\n",(0,i.jsx)(e.p,{children:"\u5728 Spring AI Alibaba \u4e2d\uff0c\u5bf9 ChatOptions \u7684\u53c2\u6570\u652f\u6301\u5728 application.yml \u4e2d\u6307\u5b9a\uff0c\u4e5f\u652f\u6301\u5728\u4ee3\u7801\u4e2d\u901a\u8fc7 DashScopeChatOptions \u63d0\u4f9b\u7684 Builder \u65b9\u6cd5\u8fdb\u884c\u6784\u5efa\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"\u5728 Spring AI Alibaba DascopeChatModel#createRequest \u65b9\u6cd5\u4e2d\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"DashScopeChatOptions options = DashScopeChatOptions.builder().build();\nif (prompt.getOptions() != null) {\n    DashScopeChatOptions updatedRuntimeOptions = ModelOptionsUtils.copyToTarget(prompt.getOptions(),\n          ChatOptions.class, DashScopeChatOptions.class);\n\n    enabledToolsToUse.addAll(this.runtimeFunctionCallbackConfigurations(updatedRuntimeOptions));\n    options = ModelOptionsUtils.merge(updatedRuntimeOptions, options, DashScopeChatOptions.class);\n}\n\nif (!CollectionUtils.isEmpty(this.defaultOptions.getFunctions())) {\n    enabledToolsToUse.addAll(this.defaultOptions.getFunctions());\n}\n\noptions = ModelOptionsUtils.merge(options, this.defaultOptions, DashScopeChatOptions.class);\n\nif (!CollectionUtils.isEmpty(enabledToolsToUse)) {\n    options.setTools(this.getFunctionTools(enabledToolsToUse));\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5bf9 \u6a21\u578b\u8c03\u7528\u53c2\u6570\u8fdb\u884c\u4e86\u4e00\u7cfb\u5217\u7684 merge \u64cd\u4f5c\u3002\u4ee5\u901a\u8fc7\u4ee3\u7801\u8bbe\u7f6e\u7684 options \u4e3a\u51c6\uff0c\u5176\u6b21\u662f\u4ee5 application.yml \u4e2d\u914d\u7f6e\u7684 options \u53c2\u6570\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u901a\u8fc7\u4ee3\u7801\u8bbe\u7f6e\u7684\u53c2\u6570\u4f18\u5148\u7ea7\u9ad8\u4e8e\u914d\u7f6e\u6587\u4ef6\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"call-\u548c-stream-\u65b9\u6cd5",children:"Call \u548c Stream \u65b9\u6cd5"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"\u5728\u4e4b\u524d\u7684\u7248\u672c\u4e2d\uff0cSpring AI Alibaba \u901a\u8fc7 SDK \u6765\u9002\u914d\u901a\u4e49\u5927\u6a21\u578b\uff0c\u73b0\u5728\u90fd\u4f7f\u7528 openapi \u89c4\u8303\u7684\u63a5\u53e3\u53bb\u8c03\u7528\u5927\u6a21\u578b\u3002"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u5728 ChatModel \u4e2d\uff0c\u5b9a\u4e49\u4e86 Call \u548c Stream \u65b9\u6cd5\uff0c\u7528\u6765\u8c03\u7528\u5927\u6a21\u578b\uff0c\u524d\u8005\u662f\u6734\u7d20\u7684\u8c03\u7528\u65b9\u5f0f\uff0c\u540e\u8005\u662f\u6d41\u5f0f\u8c03\u7528\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5728 Model \u63a5\u53e3\u4e2d\u5b9a\u4e49\u4e86 Call \u65b9\u6cd5\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public interface Model<TReq extends ModelRequest<?>, TRes extends ModelResponse<?>> {\n\n TRes call(TReq request);\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5728 StreamingModel \u4e2d\u5b9a\u4e49\u4e86 stream \u65b9\u6cd5\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public interface StreamingModel<TReq extends ModelRequest<?>, TResChunk extends ModelResponse<?>> {\n\n Flux<TResChunk> stream(TReq request);\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u901a\u8fc7\u4ee3\u7801\u53ef\u4ee5\u770b\u5230\u5728\u9ed8\u8ba4\u7684 ChatModel \u4e2d\u7ec4\u5408\u4e86 Model \u548c StreamingModel\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'public interface ChatModel extends Model<Prompt, ChatResponse>, StreamingChatModel {\n\n    @Override\n    ChatResponse call(Prompt prompt);\n\n    ChatOptions getDefaultOptions();\n\n    default Flux<ChatResponse> stream(Prompt prompt) {\n       throw new UnsupportedOperationException("streaming is not supported");\n    }\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u6709\u4e86\u63a5\u53e3\uff0c\u4e14\u9002\u914d\u4e86\u4e0d\u540c\u6a21\u578b\u4e4b\u540e\uff0c\u901a\u8fc7 createRequest \u6784\u9020\u4e00\u4e2a DashScopeApi#ChatCompletionRequest \u7684 request \u5bf9\u8c61\uff0c\u7528\u4e8e\u53d1\u8d77\u8c03\u7528\uff1a\uff08\uff09\u5176\u4e2d\u5305\u542b\u5bf9 options \u53c2\u6570\u7684\u5904\u7406\u548c\u5bf9 function \u7684\u5904\u7406\uff09"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"# \u6784\u5efa\u8bf7\u6c42\u53c2\u6570\nDashScopeApi.ChatCompletionRequest request = createRequest(prompt, false);\n\n# \u8c03\u7528 LLMs API\nResponseEntity<ChatCompletion> completionEntity = this.retryTemplate\n    .execute(ctx -> this.dashscopeApi.chatCompletionEntity(request));\n\n# \u51c6\u5907\u63a5\u53d7 LLMs \u54cd\u5e94\nvar chatCompletion = completionEntity.getBody();\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u5bf9 stream \u65b9\u6cd5\u7684\u8c03\u7528\u4e2d\uff0c\u548c call \u76f8\u540c\uff0c\u7ec6\u5fc3\u7684\u540c\u5b66\u4eec\uff0c\u80af\u5b9a\u53d1\u73b0\u4e86 createRequest \u65b9\u6cd5\u6709\u4e24\u4e2a\u53c2\u6570\uff0c\u7b2c\u4e00\u4e2a\u662f prompt\uff0c\u7b2c\u4e8c\u4e2a\u5c31\u662f\u51b3\u5b9a\u6b64\u6b21\u8bf7\u6c42\u662f\u5426\u662f\u6d41\u5f0f\u8c03\u7528\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"ChatCompletionRequest request = createRequest(prompt, true);\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u7ee7\u800c\uff0c\u518d\u53bb\u8c03\u7528 dashScopeApi \u7684 chatCompletionStream \u65b9\u6cd5\u5b8c\u6210\u8bf7\u6c42\u3002\u6700\u540e\u63a5\u53d7\u54cd\u5e94\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u81f3\u6b64\u6211\u4eec\u5df2\u7ecf\u5b8c\u6210\u4e86\u5bf9 call \u548c stream \u8bf7\u6c42\u65b9\u5f0f\u7684\u89e3\u6790\uff0c\u4ece\u6e90\u7801\u5b9e\u73b0\u4e0a\u975e\u5e38\u7b80\u5355\u3002\u73b0\u5728\u6765\u5206\u6790\u4e00\u4e0b Spring AI \u4e2d\u5b9a\u4e49\u7684\u7528\u6765\u63a5\u53d7\u6a21\u578b\u54cd\u5e94\u7684\u7c7b ChatResponse\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"ChatResponse",src:t(84578).A+"",width:"1640",height:"1968"})}),"\n",(0,i.jsx)(e.p,{children:"\u5176\u4e2d\u5143\u6570\u636e\u63a5\u53e3\u4e13\u6ce8\u4e8e\u63d0\u4f9b AI \u6a21\u578b\u751f\u6210\u7ed3\u679c\u7684\u66f4\u591a\u80cc\u666f\u4fe1\u606f\u548c\u89c1\u89e3\u3002\u5b83\u53ef\u80fd\u5305\u62ec\u8ba1\u7b97\u65f6\u95f4\u3001\u6a21\u578b\u7248\u672c\u548c Usage \u7b49\u5176\u4ed6\u76f8\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u4ee5\u589e\u5f3a\u5bf9\u5404\u79cd\u5e94\u7528\u4e2d\u7684 AI \u6a21\u578b\u8f93\u51fa\u7684\u7406\u89e3\u548c\u7ba1\u7406\u3002"}),"\n",(0,i.jsx)(e.p,{children:"Generation \u7c7b\u662f\u4e00\u4e2a\u8bb0\u5f55 AI \u8fd4\u56de\u4fe1\u606f\u7684\u5b9e\u4f53\u7c7b\u3002\u6709\u4e24\u4e2a\u7c7b\u6210\u5458\uff1a\u4e00\u4e2a\u4e3a ChatGenerationMetadata\uff0c\u4e00\u4e2a\u662f AssistantMessage\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5176\u4e2d AssistantMessage \u662f\u8ba9 LLMs \u77e5\u6653\u6b64\u7c7b\u578b\u7684\u6d88\u606f\u7c7b\u578b\u662f\u4f5c\u4e3a\u7528\u6237\u54cd\u5e94\u751f\u6210\u7684\u3002\u5b9e\u73b0\u4e86 Message \u548c Content \u7c7b\u578b\uff1a\u7c7b\u56fe\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"AbstractMessage",src:t(5707).A+"",width:"2112",height:"1332"})}),"\n",(0,i.jsx)(e.p,{children:"\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u56db\u79cd\u7c7b\u578b\u7684\u5b9e\u73b0\uff0c\u8fd9\u91cc\u6211\u4eec\u4e0d\u8ba8\u8bba\u5b9e\u73b0\uff0c\u540e\u7eed\u6587\u7ae0\u4f1a\u4ecb\u7ecd\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u81f3\u6b64\u4fbf\u662f\u6574\u4e2a Spring AI \u7684 ChatReponse \u7684\u6e90\u7801\u5b9e\u73b0\uff0c\u53ef\u4ee5\u770b\u5230 Spring AI \u5b9a\u4e49\u4e86\u4e00\u7cfb\u5217\u7684\u63a5\u53e3\u6765\u7ea6\u675f\u5b9e\u73b0\u7c7b\u7684\u884c\u4e3a\u3002\u4f7f\u5f97\u6574\u4e2a Spring AI \u4f53\u7cfb\u903b\u8f91\u66f4\u52a0\u4e25\u5bc6\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"function-\u5904\u7406",children:"Function \u5904\u7406"}),"\n",(0,i.jsx)(e.p,{children:"\u5728 LLMs \u4e2d\u4e3a\u4e86\u89e3\u51b3\u5b9e\u65f6\u6027\u7684\u95ee\u9898\uff0c\u63d0\u4f9b\u4e86\u51fd\u6570\u8c03\u7528\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u8c03\u7528\u5916\u90e8\u7684\u4e00\u4e9b\u5de5\u5177\u51fd\u6570\u6765\u8865\u5145\u81ea\u8eab\u77e5\u8bc6\uff0c\u7ed9\u7528\u6237\u6b63\u786e\u7684\u54cd\u5e94\u3002\u5728 Spring AI \u4e2d\u4e5f\u63d0\u4f9b\u4e86\u5bf9\u51fd\u6570\u8c03\u7528\u7684\u96c6\u6210\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4e0b\u9762\u4ee5 DashScope \u7684 ChatModel \u4e2d\u7684 Function \u5b9e\u73b0\u6765\u5206\u6790\u4e00\u6ce2\u5177\u4f53\u7684\u5b9e\u73b0\u3002\u5728 IDEA \u4e2d\u5173\u7cfb\u56fe\u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"Spring AI Alibaba Function",src:t(55796).A+"",width:"2550",height:"1044"})}),"\n",(0,i.jsx)(e.p,{children:"\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Spring AI \u4e3b\u8981\u901a\u8fc7 AbstractToolCallSupport \u8fd9\u4e2a\u62bd\u8c61\u7c7b\u6765\u5b8c\u6210\u6574\u4e2a\u51fd\u6570\u8c03\u7528\u7684\u5de5\u5177\u94fe\u62bd\u8c61\u3002\u901a\u8fc7\u6784\u9020\u7ec4\u5408\u76f8\u5173\u7684\u7c7b\uff0c\u5176\u4e2d\u7c7b\u8bf4\u660e\u5982\u4e0b\uff1a"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"AbstractToolCallSupport\uff1a\uff08\u6b64\u7c7b\u5df2\u7ecf\u7ecf\u8fc7\u597d\u51e0\u8f6e\u8fed\u4ee3\uff0c\u4e0d\u77e5\u9053\u540e\u7eed\u4f1a\u4e0d\u4f1a\u5728\u53d8\u52a8\uff0c\u4e4b\u524d\u7684\u540d\u5b57\u662f AbstractFunctionCallSupport\uff09\u5176\u4e2d\u7ef4\u62a4\u4e00\u7ec4 Map \u96c6\u5408\u7684 FunctionCallback \u5bf9\u8c61\uff0c\u63d0\u4f9b\u7528\u4e8e\u5904\u7406\u51fd\u6570\u56de\u8c03\u548c\u8fd0\u884c\u51fd\u6570\u7684\u529f\u80fd\uff1b"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"FunctionCallback\uff1a\u63a5\u53e3\u5b9e\u73b0\uff0c\u5185\u90e8\u5b9a\u4e49\u4e86\u4e00\u4e2a Function \u5fc5\u987b\u8981\u7684\u4e00\u4e9b\u5c5e\u6027\u548c\u65b9\u6cd5\uff0c\u5982 Name\uff0cDesc \u7b49\uff1b"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"public interface FunctionCallback {\n    String getName();\n    String getDescription();\n    String getInputTypeSchema();\n    String call(String functionInput);\n}\n"})}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"FunctionCallbackContext\uff1a\u5b9e\u73b0 Spring \u7684 ApplicationContextAware \u63a5\u53e3\uff0c\u4ece Spring context \u4e2d\u83b7\u53d6 Function Bean\uff1b"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsx)(e.p,{children:"AbstractFunctionCallback\uff1a\u627f\u4e0a\u542f\u4e0b\uff0c\u5bf9\u5927\u6a21\u578b\u9700\u8981\u8f6c\u6362\u4e3a\u5927\u6a21\u578b\u9700\u8981\u7684\u51fd\u6570\u8c03\u7528\u534f\u8bae\uff0c\u5bf9\u4e8e3rd\uff0c\u9700\u8981\u5305\u88c5\u8c03\u7528\u7b2c\u4e09\u65b9\u670d\u52a1\u6216\u8005\u51fd\u6570\u3002\u5728\u4f7f\u7528\u4e0a\u5bf9\u8be5\u7c7b\u662f\u65e0\u611f\u77e5\u7684\uff1b"}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["\n",(0,i.jsxs)(e.p,{children:["FunctionCallbackWrapper\uff1a\u5c06\u8f93\u51fa\u8f6c\u6362\u4e3a\u6a21\u578b\u53ef\u4ee5\u4f7f\u7528\u7684\u683c\u5f0f\uff0c\u9ed8\u8ba4\u5b9e\u73b0\u662f\u5c06\u8f93\u51fa\u53d1\u9001\u7ed9\u6a21\u578b\u4e4b\u524d\u5c06\u5176\u8f6c\u6362\u4e3a\u5b57\u7b26\u4e32\u3002\u53ef\u4ee5\u63d0\u4f9b\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u51fd\u6570",(0,i.jsx)(e.code,{children:"responseConverter"}),"\u5b9e\u73b0\u6765\u8986\u76d6\u6b64\u64cd\u4f5c\u3002"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u6b64\u5c0f\u8282\u4e2d\uff0c\u5c06\u4ece\u4ee5\u4e0b\u51e0\u4e2a\u65b9\u9762\u6765\u5206\u6790\uff1a"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"\u51fd\u6570\u662f\u5982\u4f55\u5b9a\u4e49\u4ee5\u53ca\u5982\u4f55\u88ab LLMs \u611f\u77e5\u5230\u7684\uff1f"}),"\n",(0,i.jsx)(e.li,{children:"Spring AI \u5728\u8c03\u7528 LLMs \u65f6\u5bf9 Function \u505a\u4e86\u90a3\u4e9b\u5904\u7406\uff1f"}),"\n",(0,i.jsx)(e.li,{children:"\u4e00\u4e2a\u5b8c\u6574\u7684 Function \u8c03\u7528\u6d41\u7a0b\u3002"}),"\n"]}),"\n",(0,i.jsx)(e.h5,{id:"1-function-\u5b9a\u4e49\u548c-llms-\u611f\u77e5",children:"1. Function \u5b9a\u4e49\u548c LLMs \u611f\u77e5"}),"\n",(0,i.jsx)(e.p,{children:"\u901a\u8fc7\u4e0a\u9762\u7684\u7c7b\u8bf4\u660e\uff0c\u53ef\u4ee5\u77e5\u9053 Spring AI \u7684 Function Bean \u901a\u8fc7 Spring \u63d0\u4f9b\u7684 IOC \u673a\u5236\u6765\u53d1\u73b0\u548c\u6ce8\u518c Function\uff0c\u5728 FunctionCallbackContext \u4e2d\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'public FunctionCallback getFunctionCallback(@NonNull String beanName, @Nullable String defaultDescription) {\n        Type beanType = FunctionContextUtils.findType(this.applicationContext.getBeanFactory(), new String[]{beanName});\n        if (beanType == null) {\n            throw new IllegalArgumentException("Functional bean with name: " + beanName + " does not exist in the context.");\n        } else if (!Function.class.isAssignableFrom(FunctionTypeUtils.getRawType(beanType)) && !BiFunction.class.isAssignableFrom(FunctionTypeUtils.getRawType(beanType))) {\n            throw new IllegalArgumentException("Function call Bean must be of type Function or BiFunction. Found: " + beanType.getTypeName());\n        } else {\n            Type functionInputType = TypeResolverHelper.getFunctionArgumentType(beanType, 0);\n            Class<?> functionInputClass = FunctionTypeUtils.getRawType(functionInputType);\n            String functionDescription = defaultDescription;\n            if (!StringUtils.hasText(defaultDescription)) {\n                Description descriptionAnnotation = (Description)this.applicationContext.findAnnotationOnBean(beanName, Description.class);\n                if (descriptionAnnotation != null) {\n                    functionDescription = descriptionAnnotation.value();\n                }\n\n                if (!StringUtils.hasText(functionDescription)) {\n                    JsonClassDescription jsonClassDescriptionAnnotation = (JsonClassDescription)functionInputClass.getAnnotation(JsonClassDescription.class);\n                    if (jsonClassDescriptionAnnotation != null) {\n                        functionDescription = jsonClassDescriptionAnnotation.value();\n                    }\n                }\n\n                if (!StringUtils.hasText(functionDescription)) {\n                    throw new IllegalStateException("Could not determine function description.Please provide a description either as a default parameter, via @Description annotation on the bean or @JsonClassDescription annotation on the input class.");\n                }\n            }\n\n            Object bean = this.applicationContext.getBean(beanName);\n            if (bean instanceof Function) {\n                Function<?, ?> function = (Function)bean;\n                return FunctionCallbackWrapper.builder(function).withName(beanName).withSchemaType(this.schemaType).withDescription(functionDescription).withInputType(functionInputClass).build();\n            } else if (bean instanceof BiFunction) {\n                BiFunction<?, ?, ?> biFunction = (BiFunction)bean;\n                return FunctionCallbackWrapper.builder(biFunction).withName(beanName).withSchemaType(this.schemaType).withDescription(functionDescription).withInputType(functionInputClass).build();\n            } else {\n                throw new IllegalArgumentException("Bean must be of type Function");\n            }\n        }\n    }\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u53ef\u4ee5\u770b\u5230\uff1a"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsx)(e.li,{children:"\u5148\u901a\u8fc7 FunctionContextUtils.findType() \u83b7\u53d6 bean \u7c7b\u578b\uff1b"}),"\n",(0,i.jsx)(e.li,{children:"\u68c0\u67e5 Bean \u7c7b\u578b\u662f\u5426\u4e3a Function \u6216\u8005 BiFunction \u7c7b\u578b\uff1b"}),"\n",(0,i.jsx)(e.li,{children:"\u83b7\u53d6 Function \u53c2\u6570\u7c7b\u578b\u5e76\u8f6c\u6362\u4e3a\u5bf9\u5e94\u7684 Bean \u7c7b\u578b\uff1b"}),"\n",(0,i.jsxs)(e.li,{children:["\u83b7\u53d6\u51fd\u6570\u63cf\u8ff0\uff1a\u5982\u679c ",(0,i.jsx)(e.code,{children:"defaultDescription"})," \u4e3a\u7a7a\uff0c\u5c1d\u8bd5\u4ece bean \u7684\u6ce8\u89e3\uff08\u5982 ",(0,i.jsx)(e.code,{children:"@Description"})," \u6216 ",(0,i.jsx)(e.code,{children:"@JsonClassDescription"}),"\uff09\u83b7\u53d6\u63cf\u8ff0\u3002\u627e\u4e0d\u5230\u63cf\u8ff0\uff0c\u5219\u629b\u51fa ",(0,i.jsx)(e.code,{children:"IllegalStateException"}),"\u3002"]}),"\n",(0,i.jsx)(e.li,{children:"\u83b7\u53d6 Bean \u521b\u5efa FunctionCallbackWrapper \u5bf9\u8c61\u3002"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u81f3\u6b64\uff0c\u4fbf\u6709\u4e86\u4e00\u4e2a\u5305\u88c5\u7684 FunctionCallbackWrapper \u5b9e\u4f8b\u5bf9\u8c61\uff0c\u5728 DashScopeChatModel#createRequest() \u6574\u5408 Function \u4fe1\u606f\uff0c"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'List<ChatCompletionMessage> chatCompletionMessages = prompt.getInstructions().stream().map(message -> {\n    if (message.getMessageType() == MessageType.USER || message.getMessageType() == MessageType.SYSTEM) {\n        Object content = message.getContent();\n        if (message instanceof UserMessage userMessage) {\n            if (!CollectionUtils.isEmpty(userMessage.getMedia())) {\n                content = convertMediaContent(userMessage);\n            }\n        }\n\n        return List.of(new ChatCompletionMessage(content,\n                ChatCompletionMessage.Role.valueOf(message.getMessageType().name())));\n    }\n    else if (message.getMessageType() == MessageType.ASSISTANT) {\n        var assistantMessage = (AssistantMessage) message;\n        List<ToolCall> toolCalls = null;\n        if (!CollectionUtils.isEmpty(assistantMessage.getToolCalls())) {\n            toolCalls = assistantMessage.getToolCalls().stream().map(toolCall -> {\n                var function = new ChatCompletionFunction(toolCall.name(), toolCall.arguments());\n                return new ToolCall(toolCall.id(), toolCall.type(), function);\n            }).toList();\n        }\n        return List.of(new ChatCompletionMessage(assistantMessage.getContent(),\n                ChatCompletionMessage.Role.ASSISTANT, null, null, toolCalls));\n    }\n    else if (message.getMessageType() == MessageType.TOOL) {\n        ToolResponseMessage toolMessage = (ToolResponseMessage) message;\n\n        toolMessage.getResponses().forEach(response -> {\n            Assert.isTrue(response.id() != null, "ToolResponseMessage must have an id");\n            Assert.isTrue(response.name() != null, "ToolResponseMessage must have a name");\n        });\n\n        return toolMessage.getResponses()\n            .stream()\n            .map(tr -> new ChatCompletionMessage(tr.responseData(), ChatCompletionMessage.Role.TOOL, tr.name(),\n                    tr.id(), null))\n            .toList();\n    }\n    else {\n        throw new IllegalArgumentException("Unsupported message type: " + message.getMessageType());\n    }\n}).flatMap(List::stream).toList();\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u4e4b\u540e\u4f20\u7ed9 LLMs\uff0c\u5728 LLMs \u5224\u65ad\u9700\u8981\u8c03\u7528\u51fd\u6570\u7684\u65f6\u5019\u7ed9 Spring AI \u53d1\u9001\u4fe1\u53f7\uff0c\u5b8c\u6210\u8c03\u7528\u3002"}),"\n",(0,i.jsx)(e.h5,{id:"2-spring-ai-functions",children:"2. Spring AI Functions"}),"\n",(0,i.jsxs)(e.p,{children:["\u4e0a\u9762\u6211\u4eec\u5df2\u7ecf\u57fa\u672c\u5206\u6790\u5b8c\u6210\u4e86 Function \u7684\u5927\u90e8\u5206\u80fd\u529b\u3002\u63a5\u4e0b\u6765\u5206\u6790\u4ee5\u4e0b\u5728 Spring AI \u4e2d\u662f\u5982\u4f55\u8c03\u7528 Function \uff0c\u4ee5\u53ca LLMs \u7ed9\u4e86 Spring AI \u4ec0\u4e48\u4fe1\u53f7\u6765\u8c03\u7528 Function\u3002\u6211\u4eec\u6765\u5206\u6790\u4e00\u6ce2 DashScopeChatModel#call() \u65b9\u6cd5\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u7684\u4ee3\u7801\uff0cSpring AI \u4f1a\u6839\u636e ",(0,i.jsx)(e.code,{children:"finishReason"})," \u6765\u5224\u65ad\u662f\u5426\u9700\u8981\u6267\u884c\u51fd\u6570\u3002\u5177\u4f53\u4ee3\u7801\u5982\u4e0b\uff1a"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'# DashScopeChatModel.java\n\nif (isToolCall(chatResponse,\n               Set.of(ChatCompletionFinishReason.TOOL_CALLS.name(), ChatCompletionFinishReason.STOP.name()))) {\n    var toolCallConversation = handleToolCalls(prompt, chatResponse);\n    // Recursively call the call method with the tool call message\n    // conversation that contains the call responses.\n    return this.call(new Prompt(toolCallConversation, prompt.getOptions()));\n}\n\nreturn chatResponse;\n\n# AbstractToolCallSupport.java\n\nprotected boolean isToolCall(ChatResponse chatResponse, Set<String> toolCallFinishReasons) {\n    Assert.isTrue(!CollectionUtils.isEmpty(toolCallFinishReasons), "Tool call finish reasons cannot be empty!");\n    if (chatResponse == null) {\n        return false;\n    } else {\n        List<Generation> generations = chatResponse.getResults();\n        return CollectionUtils.isEmpty(generations) ? false : generations.stream().anyMatch((g) -> {\n            return this.isToolCall(g, toolCallFinishReasons);\n        });\n    }\n}\n\nprotected boolean isToolCall(Generation generation, Set<String> toolCallFinishReasons) {\n    String finishReason = generation.getMetadata().getFinishReason() != null ? generation.getMetadata().getFinishReason() : "";\n    return generation.getOutput().hasToolCalls() && toolCallFinishReasons.stream().map((s) -> {\n        return s.toLowerCase();\n    }).toList().contains(finishReason.toLowerCase());\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"\u5728\u5224\u65ad\u5b8c\u6210\uff0c\u5982\u4e0b\u9700\u8981\u8c03\u7528\u51fd\u6570\uff0c\u5219\u4f1a\u6267\u884c AbstractToolCallSupport \u4e2d\u7684 handleToolCalls \u65b9\u6cd5\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:" AssistantMessage assistantMessage = ((Generation)toolCallGeneration.get()).getOutput();\n    Map<String, Object> toolContextMap = Map.of();\n    ChatOptions var7 = prompt.getOptions();\n    if (var7 instanceof FunctionCallingOptions) {\n        FunctionCallingOptions functionCallOptions = (FunctionCallingOptions)var7;\n        if (!CollectionUtils.isEmpty(functionCallOptions.getToolContext())) {\n            toolContextMap = functionCallOptions.getToolContext();\n        }\n    }\n\n    ToolResponseMessage toolMessageResponse = this.executeFunctions(assistantMessage, new ToolContext(toolContextMap));\n    return this.buildToolCallConversation(prompt.getInstructions(), assistantMessage, toolMessageResponse);\n"})}),"\n",(0,i.jsx)(e.p,{children:"\u6700\u540e\u6267\u884c\u5b8c\u6210\u5c06\u7ed3\u679c\u8fd4\u56de\u3002"}),"\n",(0,i.jsx)(e.h5,{id:"3-function-call-debug",children:"3. Function Call Debug"}),"\n",(0,i.jsx)(e.p,{children:"\u7ecf\u8fc7\u4e0a\u9762\u7684\u4ee3\u7801\u5206\u6790\u6211\u4eec\u641e\u6e05\u695a\u4e86\u4ee3\u7801\u7f16\u5199\uff0c\u4e0d\u8fc7\u7eb8\u4e0a\u770b\u6765\u7ec8\u89c9\u6d45\u3002\u73b0\u5728\u6211\u4eec\u6765 debug \u4e00\u6ce2\u770b\u770b\u600e\u4e48\u4e2a\u4e8b\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u76f4\u63a5\u4f7f\u7528 Spring Al Alibaba \u4e2d\u7684 function-calling-example\uff1a"}),"\n",(0,i.jsx)(e.p,{children:"MockWeatherService Function \u5982\u4e0b\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'public class MockWeatherService implements Function<MockWeatherService.Request, Response> {\n\n    @Override\n    public Response apply(Request request) {\n        if (request.city().contains("\u676d\u5dde")) {\n            return new Response(String.format("%s%s\u6674\u8f6c\u591a\u4e91, \u6c14\u6e2932\u6444\u6c0f\u5ea6\u3002", request.date(), request.city()));\n        }\n        else if (request.city().contains("\u4e0a\u6d77")) {\n            return new Response(String.format("%s%s\u591a\u4e91\u8f6c\u9634, \u6c14\u6e2931\u6444\u6c0f\u5ea6\u3002", request.date(), request.city()));\n        }\n        else {\n            return new Response(String.format("\u6682\u65f6\u65e0\u6cd5\u67e5\u8be2%s\u7684\u5929\u6c14\u72b6\u51b5\u3002", request.city()));\n        }\n    }\n\n    @JsonInclude(JsonInclude.Include.NON_NULL)\n    @JsonClassDescription("\u6839\u636e\u65e5\u671f\u548c\u57ce\u5e02\u67e5\u8be2\u5929\u6c14")\n    public record Request(\n            @JsonProperty(required = true, value = "city") @JsonPropertyDescription("\u57ce\u5e02, \u6bd4\u5982\u676d\u5dde") String city,\n            @JsonProperty(required = true, value = "date") @JsonPropertyDescription("\u65e5\u671f, \u6bd4\u59822024-08-22") String date) {\n    }\n\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"controller \u4ee3\u7801\u5982\u4e0b\uff0c\u6784\u9020\u4e00\u4e2a\u5e26\u6709 Function \u63cf\u8ff0\u7684 prompt\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'@GetMapping("/weather-service")\npublic String weatherService(String subject) {\n    return chatClient.prompt()\n            .function("getWeather", "\u6839\u636e\u57ce\u5e02\u67e5\u8be2\u5929\u6c14", new MockWeatherService())\n            .user(subject)\n            .call()\n            .content();\n}\n'})}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"Tips:  Spring AI Function \u63d0\u4f9b\u591a\u79cd Function \u4f7f\u7528\u7684\u65b9\u5f0f\uff0c\u901a\u8fc7\u5728 prompt \u7684 function \u53c2\u6570\u6307\u5b9a\u6216\u662f\u901a\u76f4\u63a5\u4f7f\u7528 @Bean \u6307\u5b9a\u90fd\u53ef\u4ee5\u8fbe\u5230\u4f7f\u7528\u76ee\u7684\uff0c\u4e0d\u5fc5\u62d8\u6ce5\u4e8e\u5f62\u5f0f\u3002"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"\u6211\u4eec\u5148\u4ece call \u7684 FunctionCallbackContext#call() \u65b9\u6cd5\u5f00\u59cb\u6253\u65ad\u70b9\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"image-20241208195709304",src:t(88829).A+"",width:"1802",height:"901"})}),"\n",(0,i.jsxs)(e.p,{children:["\u53ef\u4ee5\u770b\u5230 function \u4fe1\u606f\u5df2\u7ecf\u5728 chatOptions \u5bf9\u8c61\u4e2d\uff0c\u5e26\u6709 Function \u63cf\u8ff0\u7b49\u4fe1\u606f\uff0c\u63a5\u7740\u5f80\u4e0b\u53ef\u4ee5\u770b\u5230\u7b2c\u4e00\u6b21\u7684 finishResaon \u4e3a ",(0,i.jsx)(e.code,{children:"TOOL_CALLS"}),"\uff0c\u63a5\u4e0b\u6765 Spring AI \u4fbf\u4f1a\u53bb\u6267\u884c\u51fd\u6570"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"image-20241208195934104",src:t(91270).A+"",width:"1696",height:"826"})}),"\n",(0,i.jsx)(e.p,{children:"\u5728 AbstractToolCallSupport#executeFunctions() \u6253\u65ad\u70b9\u5982\u4e0b\uff1a\u4fbf\u53ef\u770b\u5230 Function \u6267\u884c\u7684\u7ed3\u679c\uff1a"}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"image-20241208200708564",src:t(30287).A+"",width:"1752",height:"882"})}),"\n",(0,i.jsxs)(e.p,{children:["\u5f53\u7ee7\u7eed\u5f80\u4e0b\u6267\u884c\u65f6\uff0c\u4fbf\u4f1a\u770b\u5230 finishReason \u7684\u6570\u636e\u4e3a ",(0,i.jsx)(e.code,{children:"STOP"}),"\uff1a"]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.img,{alt:"image-20241208201015609",src:t(5336).A+"",width:"1829",height:"750"})}),"\n",(0,i.jsx)(e.p,{children:"\u81f3\u6b64\uff0c\u4fbf\u5b8c\u6210\u4e86 Function \u7684\u8c03\u7528\u3002"}),"\n",(0,i.jsx)(e.h5,{id:"4-\u603b\u7ed3",children:"4. \u603b\u7ed3"}),"\n",(0,i.jsx)(e.p,{children:"\u53ef\u4ee5\u770b\u5230 Function \u662f\u4e00\u4e2a\u975e\u5e38\u5f3a\u5927\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u5f25\u8865 LLMs \u5b9e\u65f6\u6570\u636e\u7684\u7f3a\u9677\u6027\uff0c\u7ed9\u7528\u6237\u66f4\u597d\u7684\u56de\u7b54\u3002Spring AI \u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u5957\u5b8c\u6574\u7684 Function \u89e3\u51b3\u65b9\u6848\u3002"}),"\n",(0,i.jsx)(e.h4,{id:"\u53ef\u89c2\u6d4b",children:"\u53ef\u89c2\u6d4b"}),"\n",(0,i.jsx)(e.p,{children:"\u53ef\u89c2\u6d4b\u4e00\u76f4\u662f\u884c\u4e1a\u5185\u7684\u91cd\u70b9\u8bdd\u9898\uff0c\u901a\u8fc7\u5e94\u7528\u7684\u5404\u9879\u6307\u6807\uff0c\u53ef\u4ee5\u53cd\u6620\u5e94\u7528\u7684\u5065\u5eb7\u72b6\u6001\uff0c\u5e94\u7528\u6d41\u91cf\u7b49\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u5728 LLMs \u7684\u53ef\u89c2\u6d4b\u5e94\u7528\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230 Token \u7684\u4f7f\u7528\uff0c\u6bcf\u6b21\u7684 Message \u6d88\u606f\uff0c\u8017\u65f6\u7b49\u3002\u6765\u5e2e\u52a9 LLMs \u7684\u5f00\u53d1\u8005\u66f4\u597d\u7684\u8c03\u8bd5 LLMs \u5e94\u7528\u7684\u53c2\u6570\u8bbe\u7f6e\uff0c\u6765\u8ba9\u5e94\u7528\u63d0\u4f9b\u6700\u51c6\u786e\u7684\u56de\u7b54\u3002"}),"\n",(0,i.jsx)(e.p,{children:"Spring AI \u7684\u53ef\u89c2\u6d4b\u901a\u8fc7\u8bb0\u5f55\u6bcf\u6b21\u7684 prompt \u548c\u4e00\u4e9b\u5143\u6570\u636e\u53c2\u6570\u4ee5\u53ca\u6a21\u578b\u8fd4\u56de\u6765\u8fbe\u5230\u53ef\u89c2\u6d4b\u7684\u76ee\u7684\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:'ChatModelObservationContext observationContext = ChatModelObservationContext.builder()\n    .prompt(prompt)\n    .provider(AiProvider.DASHSCOPE.value())\n    .requestOptions(prompt.getOptions() != null ? prompt.getOptions() : this.defaultOptions)\n    .build();\n\nChatResponse chatResponse = ChatModelObservationDocumentation.CHAT_MODEL_OPERATION\n    .observation(this.observationConvention, DEFAULT_OBSERVATION_CONVENTION, () -> observationContext,\n            this.observationRegistry)\n    .observe(() -> {\n        DashScopeApi.ChatCompletionRequest request = createRequest(prompt, false);\n\n        ResponseEntity<ChatCompletion> completionEntity = this.retryTemplate\n            .execute(ctx -> this.dashscopeApi.chatCompletionEntity(request));\n\n        var chatCompletion = completionEntity.getBody();\n\n        if (chatCompletion == null) {\n            logger.warn("No chat completion returned for prompt: {}", prompt);\n            return new ChatResponse(List.of());\n        }\n\n        List<ChatCompletionOutput.Choice> choices = chatCompletion.output().choices();\n\n        List<Generation> generations = choices.stream().map(choice -> {\n    // @formatter:off\n                Map<String, Object> metadata = Map.of(\n                        "id", chatCompletion.requestId(),\n                        "role", choice.message().role() != null ? choice.message().role().name() : "",\n                        "finishReason", choice.finishReason() != null ? choice.finishReason().name() : "");\n                // @formatter:on\n            return buildGeneration(choice, metadata);\n        }).toList();\n\n        ChatResponse response = new ChatResponse(generations, from(completionEntity.getBody()));\n\n        observationContext.setResponse(response);\n\n        return response;\n    });\n'})}),"\n",(0,i.jsx)(e.h3,{id:"chatclient-api",children:"ChatClient API"}),"\n",(0,i.jsx)(e.p,{children:"ChatClient \u4e0d\u9488\u5bf9\u7279\u5b9a\u7684 LLMs \u63d0\u4f9b\u5546\uff0c\u662f\u4e00\u4e2a\u6bd4 ChatModel \u66f4\u9ad8\u7ea7\u7684 API\u3002\u4e3a LLMs  \u63d0\u4f9b\u76f4\u63a5\u5165\u53e3\uff0c\u5176\u901a\u8fc7 ChatModel \u6784\u5efa\u800c\u6765\uff1a"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-java",children:"private final ChatClient chatClient;\n\nprivate final ChatModel chatModel;\n\npublic AIController(ChatClient.Builder builder, ChatModel chatModel) {\n\n    this.chatModel = chatModel;\n    this.chatClient = ChatClient.builder(chatModel)\n        .defaultAdvisors(\n        new MessageChatMemoryAdvisor(new InMemoryChatMemory())\n    ).build();\n}\n"})}),"\n",(0,i.jsx)(e.p,{children:"Spring AI \u57fa\u4e8e ChatClient API\uff0c\u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u7684 Advisor API\uff0c\u7528\u6765\u589e\u5f3a ChatClient \u7684\u80fd\u529b\uff0c\u5176\u5185\u90e8\u5b9e\u73b0\u548c Spring AOP \u540c\u7406\u3002"}),"\n",(0,i.jsx)(e.p,{children:"\u4e3b\u8981\u529f\u80fd\u6709\uff1a"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"\u804a\u5929\u8bb0\u5fc6"}),"\n",(0,i.jsx)(e.li,{children:"\u68c0\u7d22\u589e\u5f3a\u751f\u6210"}),"\n",(0,i.jsx)(e.li,{children:"\u65e5\u5fd7\u8bb0\u5f55\u7b49"}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:["\u5b98\u7f51\u6587\u6863\u5730\u5740\uff1a",(0,i.jsx)(e.a,{href:"https://docs.spring.io/spring-ai/reference/api/chatclient.html",children:"https://docs.spring.io/spring-ai/reference/api/chatclient.html"})]})]})}function h(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(p,{...n})}):p(n)}},34416:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-10-f4ce234c98cae3b94abe0ed11000fb5e.png"},40665:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-11-627ddc4ad04ca870d7c5c8eb25361718.png"},84578:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-12-cb56d388fb6264d37bbfd6f946705430.png"},5707:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-13-fce8608b648c77991fac9005bc044f88.png"},55796:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-14-38bb4b59ffaac1a1df62a4ec16cf56cb.png"},88829:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-15-1bee66cc8833984ec49d727f0597b46b.png"},91270:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-16-be907476fc6f96224ff5ba4115ba0ab7.png"},30287:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-17-cf1f8c56989d0aef1415dc98757a8014.png"},5336:(n,e,t)=>{t.d(e,{A:()=>s});const s=t.p+"assets/images/ai-18-ec2104029ef640fcbc129b98e83ee827.png"},89999:(n,e,t)=>{t.d(e,{R:()=>o,x:()=>l});var s=t(58101);const i={},a=s.createContext(i);function o(n){const e=s.useContext(a);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:o(n.components),s.createElement(a.Provider,{value:e},n.children)}},96687:n=>{n.exports=JSON.parse('{"permalink":"/blog/LLMs-AI-Spring-AI-Alibaba-chat-source","editUrl":"https://github.com/yuluo-yx/blog/edit/master/blog/AI-large-models/\u5927\u6a21\u578b\u4e13\u680f-Spring-AI-Alibaba-Chat-\u6e90\u7801\u5206\u6790.md","source":"@site/blog/AI-large-models/\u5927\u6a21\u578b\u4e13\u680f-Spring-AI-Alibaba-Chat-\u6e90\u7801\u5206\u6790.md","title":"\u5927\u6a21\u578b\u4e13\u680f--Spring AI Alibaba Chat \u6e90\u7801\u5206\u6790","description":"Chat \u529f\u80fd\u662f LLMs \u5e94\u7528\u7684\u6700\u57fa\u7840\u529f\u80fd\uff0c\u4efb\u4f55\u529f\u80fd\u90fd\u8981\u5411 LLMs \u5e94\u7528\u7ed9\u8f93\u5165\uff0c\u4e4b\u540e\u5c06\u83b7\u5f97 LLMs \u7684\u8fd4\u56de\u3002\u5176\u5e95\u5c42\u662f NLP \u7684\u5b9e\u73b0\u3002\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u4e0d\u4f1a\u5206\u6790 LLMs \u7684\u5e95\u5c42\u5b9e\u73b0\uff0c\u4f1a\u5206\u6790\u4e00\u6ce2 Spring AI Albaba \u7684 Chat \u529f\u80fd\u5b9e\u73b0\u548c Spring AI \u63d0\u4f9b\u7684 Chat \u63a5\u53e3\u5b9e\u73b0\u3002","date":"2024-12-08T21:24:56.000Z","tags":[{"inline":true,"label":"AI","permalink":"/blog/tags/ai"},{"inline":true,"label":"Spring AI Alibabe","permalink":"/blog/tags/spring-ai-alibabe"},{"inline":true,"label":"chat","permalink":"/blog/tags/chat"}],"readingTime":10.76,"hasTruncateMarker":true,"authors":[{"name":"\u7267\u751f","title":"Java & go developer","url":"https://github.com/yuluo-yx","email":"yuluo08290126@gmail.com","socials":{"x":"https://x.com/yuluo","github":"https://github.com/yuluo-yx"},"imageURL":"https://kuizuo.cn/img/logo.png","key":"yuluo","page":null}],"frontMatter":{"slug":"LLMs-AI-Spring-AI-Alibaba-chat-source","title":"\u5927\u6a21\u578b\u4e13\u680f--Spring AI Alibaba Chat \u6e90\u7801\u5206\u6790","date":"2024-12-08T21:24:56.000Z","authors":"yuluo","tags":["AI","Spring AI Alibabe","chat"],"keywords":["AI","Spring AI Aliabab","chat source"]},"unlisted":false,"prevItem":{"title":"\u5927\u6a21\u578b\u4e13\u680f--Spring AI Chat Memory \u6e90\u7801\u5206\u6790","permalink":"/blog/LLMs-AI-Spring-AI-Alibaba-chat-memory-source"},"nextItem":{"title":"\u5927\u6a21\u578b\u4e13\u680f--\u5927\u6a21\u578b\u5f00\u53d1\u6846\u67b6","permalink":"/blog/LLMs-AI-llms-dev-framework"}}')}}]);