"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[7115],{29985:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>s,metadata:()=>t,toc:()=>o});var t=r(25193),i=r(25105),a=r(89999);const s={slug:"trace-transfer",title:"\u5f02\u6784\u670d\u52a1\u94fe\u8def\u8ffd\u8e2a",date:new Date("2025-09-14T20:49:08.000Z"),authors:"yuluo",tags:["Java","Go","Trace","Heterogeneous"],keywords:["Java","Go","Trace","Heterogeneous"]},l=void 0,c={authorsImageUrls:[void 0]},o=[{value:"Zipkin \u542f\u52a8",id:"zipkin-\u542f\u52a8",level:2},{value:"\u5173\u952e\u6027\u914d\u7f6e",id:"\u5173\u952e\u6027\u914d\u7f6e",level:2},{value:"SCG",id:"scg",level:3},{value:"user-service",id:"user-service",level:3},{value:"Kratos",id:"kratos",level:3},{value:"Zipkin trace \u622a\u56fe",id:"zipkin-trace-\u622a\u56fe",level:2},{value:"\u5176\u4ed6\u95ee\u9898",id:"\u5176\u4ed6\u95ee\u9898",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"\u6587\u4e2d\u4f7f\u7528\u7684\u6846\u67b6\u548c\u670d\u52a1\uff1a"}),"\n",(0,i.jsx)(n.p,{children:"\u7f51\u5173\uff1aSpring Cloud Gateway"}),"\n",(0,i.jsx)(n.p,{children:"\u670d\u52a1\u4e0a\u6e38\uff1aSpring Boot 3.5.1 Spring Cloud 2025.0.0.0\uff08Java\uff09"}),"\n",(0,i.jsx)(n.p,{children:"\u670d\u52a1\u4e0b\u6e38\uff1aKratos 2.8.0\uff08Go\uff09"}),"\n",(0,i.jsx)(n.p,{children:"\u94fe\u8def\u8ffd\u8e2a\u5de5\u5177\uff1aZipkin"}),"\n",(0,i.jsxs)(n.p,{children:["Demo \u5730\u5740\uff1a",(0,i.jsx)(n.a,{href:"https://github.com/deigmata-paideias/deigmata-paideias/trace-transfer",children:"https://github.com/deigmata-paideias/deigmata-paideias/trace-transfer"})]}),"\n",(0,i.jsx)(n.h2,{id:"zipkin-\u542f\u52a8",children:"Zipkin \u542f\u52a8"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"services:\n\n  zipkin:\n    image: 'openzipkin/zipkin:latest'\n    container_name: \"spring-ai-alibaba-zipkin\"\n    ports:\n      - '9411:9411'\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"docker compose up -d"})," \u6d4f\u89c8\u5668\u8bbf\u95ee 9411."]}),"\n",(0,i.jsx)(n.h2,{id:"\u5173\u952e\u6027\u914d\u7f6e",children:"\u5173\u952e\u6027\u914d\u7f6e"}),"\n",(0,i.jsx)(n.h3,{id:"scg",children:"SCG"}),"\n",(0,i.jsx)(n.p,{children:"pom.xml"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"tracing \u7ec4\u4ef6"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>io.micrometer</groupId>\n    <artifactId>micrometer-tracing</artifactId>\n</dependency>\n\n<dependency>\n    <groupId>io.micrometer</groupId>\n    <artifactId>micrometer-tracing-bridge-brave</artifactId>\n</dependency>\n\n<dependency>\n    <groupId>io.zipkin.reporter2</groupId>\n    <artifactId>zipkin-reporter-brave</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Gateway"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-webflux</artifactId>\n</dependency>\n\n\x3c!-- Spring Cloud Gateway --\x3e\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-gateway-server-webflux</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.p,{children:"application.yml"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yml",children:"management:\n  endpoints:\n    web:\n      exposure:\n        include: '*'\n  endpoint:\n    health:\n      show-details: ALWAYS\n    logfile:\n      external-file: ./logs/${spring.application.name}/console.log\n  tracing:\n    enabled: true\n    sampling.probability: 1.0\n    propagation:\n      type: w3c\n  zipkin:\n    tracing:\n      endpoint: http://localhost:9411/api/v2/spans\n\n"})}),"\n",(0,i.jsx)(n.h3,{id:"user-service",children:"user-service"}),"\n",(0,i.jsx)(n.p,{children:"pom.xml \u548c application.yml \u76f8\u540c\u3002"}),"\n",(0,i.jsx)(n.p,{children:"pom \u5dee\u5f02\uff1a"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"openfeign \u8fdc\u7a0b\u8c03\u7528"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-web</artifactId>\n</dependency>\n\n<dependency>\n    <groupId>org.springframework.cloud</groupId>\n    <artifactId>spring-cloud-starter-openfeign</artifactId>\n</dependency>\n"})}),"\n",(0,i.jsx)(n.p,{children:"FeignB3HeaderInterceptorConfig.java"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"\u5982\u679c\u4e0d\u914d\u7f6e\u6b64\u8bf7\u6c42\u62e6\u622a\uff0copenfeign \u5728 rpc \u8c03\u7528\u65f6\u4e0d\u4f1a\u81ea\u52a8\u900f\u4f20\u8bf7\u6c42\u5934\u3002"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'@Configuration\npublic class FeignB3HeaderInterceptorConfig {\n\n    @Bean\n    public RequestInterceptor b3HeaderInterceptor() {\n        return template -> {\n            ServletRequestAttributes attrs = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();\n            if (attrs != null) {\n                HttpServletRequest request = attrs.getRequest();\n                String b3 = request.getHeader("traceparent");\n                if (b3 != null) {\n                    template.header("traceparent", b3);\n                }\n            }\n        };\n    }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"OpenFeign Client"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@FeignClient(name = "kratos-user-svc", url = "http://localhost:8000")\npublic interface UserAPI {\n\n    @GetMapping(value = "/api/v1/user/{id}")\n    User getUser(@PathVariable("id") String id);\n\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u4e3b\u7c7b\u6dfb\u52a0 ",(0,i.jsx)(n.code,{children:"@EnableFeignClients"})," \u6ce8\u89e3\uff0c\u5f00\u542f FeignClient\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"kratos",children:"Kratos"}),"\n",(0,i.jsx)(n.p,{children:"main.go"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Zipkin Init."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'func zipkinTrace() {\n\n    exporter, _ := zipkin.New("http://localhost:9411/api/v2/spans")\n\n    otel.SetTracerProvider(trace.NewTracerProvider(\n       trace.WithBatcher(exporter),\n       trace.WithSampler(trace.AlwaysSample()),\n    ))\n}\n'})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"zipkingTrace"}),"  \u51fd\u6570\u653e\u5728 wireApp \u4e4b\u524d\u3002\u5426\u5219\u4f1a\u5bfc\u81f4 trace \u5931\u8d25\uff1f"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"zipkin-trace-\u622a\u56fe",children:"Zipkin trace \u622a\u56fe"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"image-20250914200501689",src:r(98255).A+"",width:"2537",height:"560"})}),"\n",(0,i.jsx)(n.h2,{id:"\u5176\u4ed6\u95ee\u9898",children:"\u5176\u4ed6\u95ee\u9898"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"tracing.propagation.type: w3c"})," \u8981\u5199 ",(0,i.jsx)(n.code,{children:"w3c"})," \uff0c",(0,i.jsx)(n.code,{children:"b3"})," \u4f1a\u5bfc\u81f4\u8bf7\u6c42\u5934\u4f20\u9012\u5931\u8d25\uff0c\u4e32\u8054\u4e0d\u8d77\u6765\u94fe\u8def\uff1f"]}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u53ef\u80fd\u548c\u4e0b\u9762\u4ee3\u7801\u6709\u5173\uff0c\u521d\u59cb\u5316\u6210 zipkin b3."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"otel.SetTracerProvider(trace.NewTracerProvider(\n  trace.WithBatcher(exporter),\n  trace.WithSampler(trace.AlwaysSample()),\n))\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["OpenFeign \u5fc5\u987b\u8981\u624b\u52a8\u8f6c\u53d1 ",(0,i.jsx)(n.code,{children:"tracing"})," header\uff1f"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["kratos http & grpc \u4e2d\u95f4\u4ef6\u6dfb\u52a0 ",(0,i.jsx)(n.code,{children:"tracing.Server()"}),"\uff1f"]}),"\n"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},98255:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/trace-c5ab29a07e69b1392dd84487af4dc2d9.png"},89999:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>l});var t=r(58101);const i={},a=t.createContext(i);function s(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(a.Provider,{value:n},e.children)}},25193:e=>{e.exports=JSON.parse('{"permalink":"/blog/trace-transfer","editUrl":"https://github.com/yuluo-yx/blog/edit/master/blog/Bug-summary/trace-transfer.md","source":"@site/blog/Bug-summary/trace-transfer.md","title":"\u5f02\u6784\u670d\u52a1\u94fe\u8def\u8ffd\u8e2a","description":"\u6587\u4e2d\u4f7f\u7528\u7684\u6846\u67b6\u548c\u670d\u52a1\uff1a","date":"2025-09-14T20:49:08.000Z","tags":[{"inline":true,"label":"Java","permalink":"/blog/tags/java"},{"inline":true,"label":"Go","permalink":"/blog/tags/go"},{"inline":true,"label":"Trace","permalink":"/blog/tags/trace"},{"inline":true,"label":"Heterogeneous","permalink":"/blog/tags/heterogeneous"}],"readingTime":1.2833333333333334,"hasTruncateMarker":true,"authors":[{"name":"\u7267\u751f","title":"Java & go developer","url":"https://github.com/yuluo-yx","email":"yuluo08290126@gmail.com","socials":{"x":"https://x.com/yuluo","github":"https://github.com/yuluo-yx"},"imageURL":"https://kuizuo.cn/img/logo.png","key":"yuluo","page":null}],"frontMatter":{"slug":"trace-transfer","title":"\u5f02\u6784\u670d\u52a1\u94fe\u8def\u8ffd\u8e2a","date":"2025-09-14T20:49:08.000Z","authors":"yuluo","tags":["Java","Go","Trace","Heterogeneous"],"keywords":["Java","Go","Trace","Heterogeneous"]},"unlisted":false,"nextItem":{"title":"go style","permalink":"/blog/go-style"}}')}}]);