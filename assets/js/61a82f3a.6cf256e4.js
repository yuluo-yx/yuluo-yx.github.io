"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[1451],{28421:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>g,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var s=t(18490),r=t(25105),a=t(89999);const i={slug:"wechatminiapp-msg-push",title:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u63a8\u9001",date:new Date("2024-10-10T22:41:01.000Z"),authors:"yuluo",tags:["Unipp","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f","Vue3"],keywords:["msg","Unipp","Vue3","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f"]},l=void 0,o={authorsImageUrls:[void 0]},c=[{value:"\u9700\u6c42\u80cc\u666f",id:"\u9700\u6c42\u80cc\u666f",level:2},{value:"\u529f\u80fd\u6d41\u7a0b\u56fe",id:"\u529f\u80fd\u6d41\u7a0b\u56fe",level:3},{value:"\u529f\u80fd\u5b9e\u73b0",id:"\u529f\u80fd\u5b9e\u73b0",level:2},{value:"\u5c0f\u7a0b\u5e8f\u9879\u76ee\u6dfb\u52a0\u5982\u4e0b\u4ee3\u7801\uff0c\u5f00\u542f\u7528\u6237\u8ba2\u9605",id:"\u5c0f\u7a0b\u5e8f\u9879\u76ee\u6dfb\u52a0\u5982\u4e0b\u4ee3\u7801\u5f00\u542f\u7528\u6237\u8ba2\u9605",level:3},{value:"\u540e\u53f0\u529f\u80fd",id:"\u540e\u53f0\u529f\u80fd",level:3},{value:"\u529f\u80fd\u63cf\u8ff0",id:"\u529f\u80fd\u63cf\u8ff0",level:4},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0",level:4},{value:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u5f00\u901a\u548c\u53d1\u9001\u6d88\u606f",id:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u5f00\u901a\u548c\u53d1\u9001\u6d88\u606f",level:3},{value:"\u6d88\u606f\u53d1\u9001\u540e\u53f0\u529f\u80fd\u5b9e\u73b0",id:"\u6d88\u606f\u53d1\u9001\u540e\u53f0\u529f\u80fd\u5b9e\u73b0",level:4},{value:"\u5c0f\u7a0b\u5e8f\u540e\u53f0\u914d\u7f6e",id:"\u5c0f\u7a0b\u5e8f\u540e\u53f0\u914d\u7f6e",level:4},{value:"\u6d88\u606f\u63a8\u9001\u914d\u7f6e",id:"\u6d88\u606f\u63a8\u9001\u914d\u7f6e",level:5},{value:"\u6a21\u677f\u6d88\u606f\u914d\u7f6e",id:"\u6a21\u677f\u6d88\u606f\u914d\u7f6e",level:5},{value:"\u6d4b\u8bd5",id:"\u6d4b\u8bd5",level:2},{value:"\u624b\u52a8\u7f16\u5199 controller \u63a5\u53e3",id:"\u624b\u52a8\u7f16\u5199-controller-\u63a5\u53e3",level:3},{value:"\u5b9e\u9645\u4f7f\u7528",id:"\u5b9e\u9645\u4f7f\u7528",level:3},{value:"\u6548\u679c\u9884\u89c8",id:"\u6548\u679c\u9884\u89c8",level:2}];function p(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"\u9700\u6c42\u80cc\u666f",children:"\u9700\u6c42\u80cc\u666f"}),"\n",(0,r.jsx)(n.p,{children:"\u7ba1\u7406\u5458\u5728\u540e\u53f0\u7ed9\u5c0f\u7a0b\u5e8f\u7528\u6237\u63a8\u9001\u4e00\u4e9b\u6d88\u606f\uff0c\u4f8b\u5982\u7528\u6237\u6536\u8d39\u901a\u77e5\uff0c\u5de5\u5355\u7ef4\u62a4\u901a\u77e5\u7b49\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u529f\u80fd\u6d41\u7a0b\u56fe",children:"\u529f\u80fd\u6d41\u7a0b\u56fe"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"\u5fae\u4fe1\u7528\u6237\u6d88\u606f\u63a8\u9001\u6d41\u7a0b\u56fe",src:t(47251).A+"",width:"1106",height:"586"})}),"\n",(0,r.jsx)(n.h2,{id:"\u529f\u80fd\u5b9e\u73b0",children:"\u529f\u80fd\u5b9e\u73b0"}),"\n",(0,r.jsx)(n.h3,{id:"\u5c0f\u7a0b\u5e8f\u9879\u76ee\u6dfb\u52a0\u5982\u4e0b\u4ee3\u7801\u5f00\u542f\u7528\u6237\u8ba2\u9605",children:"\u5c0f\u7a0b\u5e8f\u9879\u76ee\u6dfb\u52a0\u5982\u4e0b\u4ee3\u7801\uff0c\u5f00\u542f\u7528\u6237\u8ba2\u9605"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["\u7528\u6237\u8ba2\u9605\u6d88\u606f\u6587\u6863\uff1a",(0,r.jsx)(n.a,{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html",children:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html"})]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u5c0f\u7a0b\u5e8f\u4e2d\u52a0\u5165\u5982\u4e0b\u4ee3\u7801\uff0c\u5f00\u542f\u7528\u6237\u8ba2\u9605\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-tsx",children:"  uni.requestSubscribeMessage({\n    // \u6a21\u677f\u6d88\u606f id\n    tmplIds: ['tmpId'],\n    success(res) {\n      console.log(res);\n    },\n    fail(err) {\n      console.log(err);\n    }\n  })\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u5fae\u4fe1\u5f00\u53d1\u5de5\u5177\u663e\u793a\u7528\u6237\u8ba2\u9605\u6d88\u606f\u5f39\u7a97\u548c\u771f\u673a\u8c03\u8bd5\u4e2d\uff0c\u663e\u793a\u5f97\u5185\u5bb9\u4e0d\u4e00\u6837\uff0c\u6ce8\u610f\u7504\u522b\u3002"}),"\n",(0,r.jsx)(n.li,{children:"\u7528\u6237\u5728\u8ba2\u9605\u6d88\u606f\u4e4b\u540e\uff0c\u70b9\u51fb\u4e0b\u9762\u5f97\u5bf9\u53f7\u5c31\u662f\u6c38\u4e45\u8ba2\u9605\uff0c\u53ef\u4ee5\u5728\u5c0f\u7a0b\u5e8f\u8bbe\u7f6e\u4e2d\u5173\u95ed\u3002\uff08\u5b9e\u9645\u8fd8\u662f\u8d70\u4e86\u8ba2\u9605\uff0c\u4f46\u662f\u7528\u6237\u65e0\u611f\uff09"}),"\n",(0,r.jsxs)(n.li,{children:["\u7528\u6237\u8ba2\u9605\u6d88\u606f\u4e00\u5b9a\u8981\u901a\u8fc7",(0,r.jsx)(n.strong,{children:"\u7528\u6237\u70b9\u51fb\u4e8b\u4ef6\u6216\u8005\u652f\u4ed8\u56de\u8c03"}),"\u89e6\u53d1\uff0c\u5728 await \u4e2d\u4e0d\u751f\u6548\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://developers.weixin.qq.com/miniprogram/dev/api/open-api/setting/wx.getSetting.html",children:"wx.getSetting()"})," \u63a5\u53e3\u53ef\u83b7\u53d6\u7528\u6237\u5bf9\u76f8\u5173\u6a21\u677f\u6d88\u606f\u7684\u8ba2\u9605\u72b6\u6001\u3002"]}),"\n",(0,r.jsx)(n.li,{children:"\u5728\u89e6\u53d1\u7528\u6237\u8ba2\u9605\u6d88\u606f\u4e8b\u4ef6\u4e4b\u540e\uff0c\u5fae\u4fe1\u670d\u52a1\u5668\u4f1a\u53d1\u9001\u9a8c\u8bc1\u8bf7\u6c42\u5230\u5f00\u53d1\u8005\u670d\u52a1\u5668\u8fdb\u884c\u4fe1\u606f\u9a8c\u8bc1\u3002"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u540e\u53f0\u529f\u80fd",children:"\u540e\u53f0\u529f\u80fd"}),"\n",(0,r.jsx)(n.h4,{id:"\u529f\u80fd\u63cf\u8ff0",children:"\u529f\u80fd\u63cf\u8ff0"}),"\n",(0,r.jsx)(n.p,{children:"\u540e\u53f0\u529f\u80fd\u4e3b\u8981\u6709\u4ee5\u4e0b\u4e09\u4e2a\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u63a5\u53d7\u5fae\u4fe1\u670d\u52a1\u5668\u5f97\u7528\u6237\u8ba2\u9605\u6d88\u606f\u9a8c\u8bc1\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"\u9a8c\u8bc1\u901a\u8fc7\u540e\uff0c\u63a5\u53d7\u5fae\u4fe1\u670d\u52a1\u5668\u5f97\u7528\u6237\u8ba2\u9605\u6d88\u606f\u4e8b\u4ef6\uff1b"}),"\n",(0,r.jsx)(n.li,{children:"\u53d1\u9001\u6d88\u606f\u7ed9\u6307\u5b9a openId \u7528\u6237"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"\u4ee3\u7801\u5b9e\u73b0",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u5fae\u4fe1\u670d\u52a1\u5668\u6743\u9650\u9a8c\u8bc1"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u5fae\u4fe1\u6743\u9650\u9a8c\u8bc1\u7b56\u7565\uff1a"}),"\n",(0,r.jsx)(n.p,{children:"\u5c06\u81ea\u5b9a\u4e49 token \u548c timestamp\u3001nonce \u6309\u7167\u5b57\u5178\u5e8f\u6392\u5217\uff0c\u4e4b\u540e SHA1 \u52a0\u5bc6\u548c signature \u8fdb\u884c\u5bf9\u6bd4\uff0c\u76f8\u540c\u8fd4\u56de echostr\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// controller\n/**\n * \u5fae\u4fe1\u670d\u52a1\u5668\u9274\u6743\u63a5\u53e3\n *\n * @param signature \u7b7e\u540d\n * @param timestamp \u65f6\u95f4\u6233\n * @param nonce     \u968f\u673a\u6570\n * @param echostr   \u968f\u673a\u5b57\u7b26\u4e32\n * @return \u9274\u6743\u901a\u8fc7\u8fd4\u56de echostr\n */\n@GetMapping(value = "/user")\npublic String userAuth(String signature, String timestamp, String nonce, String echostr) {\n\n    return messageService.auth(signature, timestamp, nonce, echostr);\n}\n\n// service\npublic String auth(String signature, String timestamp, String nonce, String echostr) {\n\n    log.info("\u63a5\u6536\u5230\u7684\u53c2\u6570\uff1a{} {} {} {}", signature, timestamp, nonce, echostr);\n\n    String[] arr = new String[]{wxConfigProperties.getMsgToken(), timestamp, nonce};\n    Arrays.sort(arr);\n\n    StringBuilder sb = new StringBuilder();\n    for (String str : arr) {\n        sb.append(str);\n    }\n\n    String computedSignature = SHAUtil.sha1(sb.toString());\n\n    log.info("\u5fae\u4fe1\u670d\u52a1\u5668\u63a5\u6536\u5230\u7684 \u7b7e\u540d\uff1a{}", signature);\n    log.info("SHA1 \u8ba1\u7b97\u51fa\u7684\u7b7e\u540d\uff1a{}", computedSignature);\n\n    if (computedSignature.equals(signature)) {\n        return echostr;\n    } else {\n        return "";\n    }\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u5fae\u4fe1\u7528\u6237\u8ba2\u9605\u4e8b\u4ef6\u63a5\u53d7\u63a5\u53e3"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u7528\u6237\u4e8b\u4ef6\u63a5\u53e3\u5fc5\u987b\u548c\u6743\u9650\u9a8c\u8bc1\u63a5\u53e3\u540c\u540d\uff0c\u5fae\u4fe1\u670d\u52a1\u5668\u4f1a\u53d1\u9001 GET \u7528\u4e8e\u9a8c\u8bc1\uff0cPOST \u7528\u4e8e\u53d1\u9001\u7528\u6237\u8ba2\u9605\u4e8b\u4ef6\u6d88\u606f\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// controller\n/**\n* \u5fae\u4fe1\u670d\u52a1\u5668\u5904\u7406\u7528\u6237\u4e8b\u4ef6\u63a5\u53e3\n*/\n@PostMapping(value = "/user")\npublic void user(HttpServletRequest request) {\n\n    messageService.auth(request);\n}\n\n// service\n/**\n * // \u63a5\u53e3\u8fd4\u56de JSON \u548c XML \u8fd4\u56de\u4f53\u53ef\u4ee5\u5728\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u81ea\u5b9a\u4e49\u8fd4\u56de\u683c\u5f0f\u3002\n * {\n * "ToUserName":"gh_ea84a199bf81",\n * "FromUserName":"oG0NJ5Oi_3Dd1HlZJ14xfnA0sJ6s",\n * "CreateTime":1686131943,\n * "MsgType":"event",\n * "Event":"subscribe_msg_popup_event",\n * "List":{\n * "PopupScene":"0",\n * "SubscribeStatusString":"accept",\n * "TemplateId":"4ondVRxk4L20ihrJ3iI15BDK72XatGPxE0MeCVwHasQ"\n * // \u9009\u62e9\u660e\u6587\u52a0\u5bc6\u517c\u5bb9\u6a21\u5f0f\u65f6\uff0c\u8fd8\u4f1a\u8fd4\u56de\u52a0\u5bc6\u5185\u5bb9\uff0c\u65b9\u4fbf\u8c03\u8bd5\u3002\n * }\n * }\n */\npublic void user(HttpServletRequest request) {\n\n    try {\n        BufferedReader reader = new BufferedReader(new InputStreamReader(request.getInputStream()));\n        StringBuilder requestContent = new StringBuilder();\n        String line;\n        while ((line = reader.readLine()) != null) {\n            requestContent.append(line);\n        }\n        reader.close();\n\n        if (!StringUtils.hasText(requestContent.toString())) {\n            throw new ServiceException("\u5fae\u4fe1\u670d\u52a1\u5668\u54cd\u5e94\u5931\u8d25\uff01");\n        }\n        log.info("\u5fae\u4fe1\u670d\u52a1\u5668\u54cd\u5e94\uff1a{}", requestContent);\n\n        JsonNode jsonNode = JsonUtils.fromJson(requestContent.toString(), new TypeReference<>() {\n        });\n\n        // \u89e3\u6790\u4e3a JSONNode\n        String toUserName = jsonNode.get("ToUserName").asText();\n        String fromUserName = jsonNode.get("FromUserName").asText();\n        long createTime = jsonNode.get("CreateTime").asLong();\n        String msgType = jsonNode.get("MsgType").asText();\n        String event = jsonNode.get("Event").asText();\n        JsonNode listNode = jsonNode.get("List");\n        String subscribeStatus = listNode.get("SubscribeStatusString").asText();\n        String templateId = listNode.get("TemplateId").asText();\n\n        // \u9700\u8981\u4fdd\u5b58\u7684\u7528\u6237\u8ba2\u9605\u6d88\u606f\u5b9e\u4f53\u4fe1\u606f\n        WeChatMsg dbWeChatMsg = this.weChatMsgMapper.selectOneByQuery(new QueryWrapper().eq(WeChatMsg::getFromUserName, fromUserName));\n \n        // \u5982\u679c\u5df2\u7ecf\u5b58\u5728\uff0c\u5219\u66f4\u65b0\u8986\u76d6\u5b57\u6bb5\u5373\u53ef\n        if (Objects.nonNull(dbWeChatMsg)) {\n            dbWeChatMsg.setSubscribeStatus(subscribeStatus);\n            dbWeChatMsg.setTmplId(templateId);\n            dbWeChatMsg.setToUserName(toUserName);\n\n            this.weChatMsgMapper.update(dbWeChatMsg);\n        } else {\n            // \u6ca1\u6709\u5219\u63d2\u5165\u6570\u636e\n            WeChatMsg weChatMsg = new WeChatMsg();\n            weChatMsg.setId(SnowFlakeIdGenerator.generateId());\n            weChatMsg.setToUserName(toUserName);\n            weChatMsg.setFromUserName(fromUserName);\n            weChatMsg.setCreateTime(String.valueOf(createTime));\n            weChatMsg.setMsgType(msgType);\n            weChatMsg.setEvent(event);\n            weChatMsg.setTmplId(templateId);\n            weChatMsg.setSubscribeStatus(subscribeStatus);\n\n            this.weChatMsgMapper.insert(weChatMsg);\n        }\n\n    } catch (IOException e) {\n        throw new ServiceException("\u63a5\u53d7\u5fae\u4fe1\u670d\u52a1\u5668\u8ba2\u9605\u6d88\u606f\u5f02\u5e38\uff1aerr: " + e.getMessage());\n    }\n\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u5b9e\u4f53"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Table(value = "tbl_wechat_sub")\npublic class WeChatMsg {\n\n    private Long id;\n\n    private String toUserName;\n\n    private String fromUserName;\n\n    private String createTime;\n\n    private String msgType;\n\n    private String event;\n\n    private String subscribeStatus;\n\n    private String tmplId;\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u81f3\u6b64\uff0c\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u670d\u52a1\u5668\u7684\u4ea4\u4e92\u529f\u80fd\u5c31\u5b8c\u6210\u4e86\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u5f00\u901a\u548c\u53d1\u9001\u6d88\u606f",children:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u5f00\u901a\u548c\u53d1\u9001\u6d88\u606f"}),"\n",(0,r.jsx)(n.h4,{id:"\u6d88\u606f\u53d1\u9001\u540e\u53f0\u529f\u80fd\u5b9e\u73b0",children:"\u6d88\u606f\u53d1\u9001\u540e\u53f0\u529f\u80fd\u5b9e\u73b0"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u6d88\u606f\u53d1\u9001\u5668"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u540e\u53f0\u53d1\u9001\u6d88\u606f\u65f6\uff0c\u9700\u8981\u83b7\u53d6 accessToken\uff0c\u4e00\u822c2\u4e2a\u5c0f\u65f6\u5237\u65b0\u4e00\u6b21\uff0c\u9700\u8981\u52a8\u6001\u83b7\u53d6\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@Component\npublic class WeChatSubscribeMessageSender {\n\n    private static final Logger logger = org.slf4j.LoggerFactory.getLogger(WeChatSubscribeMessageSender.class);\n    \n    public void sendSubscribeMessage(String accessToken, String openid, String templateId, String page, String data) {\n       \n        try {\n            String url = GarageConstants.WeChatConstants.MsgBaseUrl + "?access_token=" + accessToken;\n\n            URL apiUrl = new URL(url);\n            HttpURLConnection connection = (HttpURLConnection) apiUrl.openConnection();\n            connection.setRequestMethod("POST");\n            connection.setRequestProperty("Content-Type", "application/json;charset=UTF-8");\n            connection.setDoOutput(true);\n\n            // \u6784\u5efa\u8bf7\u6c42\u4f53\n            String body = buildRequestBody(openid, templateId, page, data);\n            byte[] requestBodyBytes = body.getBytes(StandardCharsets.UTF_8);\n\n            // \u53d1\u9001\u8bf7\u6c42\n            connection.getOutputStream().write(requestBodyBytes);\n\n            // \u8bfb\u53d6\u54cd\u5e94\n            int responseCode = connection.getResponseCode();\n            BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));\n            StringBuilder response = new StringBuilder();\n            String line;\n            while ((line = reader.readLine()) != null) {\n                response.append(line);\n            }\n            reader.close();\n\n            if (responseCode == HttpURLConnection.HTTP_OK) {\n                // \u8bf7\u6c42\u6210\u529f\u5904\u7406\u903b\u8f91\n                logger.info("\u53d1\u9001\u8ba2\u9605\u6d88\u606f\u6210\u529f. resp: {}", response);\n            } else {\n                // \u8bf7\u6c42\u5931\u8d25\u5904\u7406\u903b\u8f91\n                logger.info("\u53d1\u9001\u8ba2\u9605\u6d88\u606f\u5931\u8d25, \u54cd\u5e94\uff1a{}", response);\n            }\n\n            connection.disconnect();\n        } catch (IOException e) {\n            throw new ServiceException("\u5fae\u4fe1\u6d88\u606f\u63a8\u9001\u5931\u8d25\uff01err: " + e.getMessage());\n        }\n    }\n\n    /**\n     * \u6784\u5efa\u8bf7\u6c42\u4f53\u7684JSON\u5b57\u7b26\u4e32\n     */\n    private String buildRequestBody(String openid, String templateId, String page, String data) {\n        \n        return String.format(\n                "{\\"touser\\":\\"%s\\",\\"template_id\\":\\"%s\\",\\"page\\":\\"%s\\",\\"data\\":%s}",\n                openid, templateId, page, data\n        );\n    }\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u53d1\u9001\u5fae\u4fe1\u6d88\u606f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'public class WeChatMsgHelper {\n\n    private static final Logger logger = LoggerFactory.getLogger(WeChatMsgHelper.class);\n\n    // \u63a8\u9001\u6d88\u606f\u7684\u65f6\u5019\u9700\u8981 accessToken\uff0c\u8fd9\u91cc\u662f\u83b7\u53d6\n    // token \u7684\u65b9\u6cd5\uff0c\u5728\u5b9e\u9645\u73af\u5883\u4e2d\uff0c\u4e00\u822c\u662f\u5b9a\u65f6\u5237\u65b0\uff0c\n    // \u4e24\u4e2a\u5c0f\u65f6\u5185\u6709\u6548\uff0c\u83b7\u53d6accesstoken\u65f6\u9700\u8981appid\u548csecret\u4fe1\u606f\uff0c\u4e00\u822c\u662f\u540e\u53f0\u53c2\u6570\u6216\u5e38\u91cf\u8fdb\u884c\u914d\u7f6e\n    // \u83b7\u53d6 accessToken \u7684\u8bf7\u6c42\u63a5\u53e3\n    private final static String GetAccessToken = GarageConstants.WeChatConstants.TokenBaseUrl + "&appid={appid}&secret={secret}";\n\n    public static String refreshAccessToken(String appid, String secret, RestTemplate restTemplate){\n\n        if(!StringUtils.hasText(appid) || !StringUtils.hasText(secret)){\n            logger.error("\u5237\u65b0\u5fae\u4fe1 AccessToken \u65f6\uff0c\u7f3a\u5c11 appid \u6216 secret \u53c2\u6570\uff01");\n            throw new ServiceException("\u5237\u65b0\u5fae\u4fe1 AccessToken \u65f6\uff0c\u7f3a\u5c11 appid \u6216 secret \u53c2\u6570\uff01");\n        }\n\n        Map<String, Object> param = new HashMap<>();\n        param.put("appid",appid);\n        param.put("secret",secret);\n\n        ResponseEntity<JSONObject> resp = restTemplate.getForEntity(\n                GetAccessToken,\n                JSONObject.class,\n                param\n        );\n\n        JSONObject jsonObj = resp.getBody();\n        String accessToken = null;\n        if(jsonObj != null){\n            accessToken = jsonObj.getStr("access_token");\n        }\n\n        return accessToken;\n    }\n\n    public static Map<String, Object> createDataItem(String name, String value) {\n\n        Map<String, Object> item = new HashMap<>();\n        item.put("value", value);\n\n        return item;\n    }\n\n    /**\n     * \u53d1\u9001\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\n     * @param configProperties \u5fae\u4fe1\u914d\u7f6e\u5c5e\u6027\n     * @param restTemplate restTemplate \u6a21\u677f\n     * @param openId \u7528\u6237 openId\n     * @param templateId \u6a21\u677f Id\n     * @param page \u70b9\u51fb\u8df3\u8f6c\u7684\u9875\u9762\u8def\u5f84\n     * @param jsonData \u53d1\u9001\u7684 json \u6570\u636e\n     * @param messageSender \u6d88\u606f\u53d1\u9001\u5668\n     */\n    public static void send(\n            WXConfigProperties configProperties,\n            RestTemplate restTemplate,\n            String openId,\n            String templateId,\n            String page,\n            String jsonData,\n            WeChatSubscribeMessageSender messageSender\n    ) {\n\n        // \u5237\u65b0 token\n        String accessToken = WeChatMsgHelper.refreshAccessToken(\n                configProperties.getAppId(),\n                configProperties.getAppSecret(),\n                restTemplate\n        );\n\n        messageSender.sendSubscribeMessage(accessToken, openId, templateId, page, jsonData);\n    }\n\n}\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"\u5728\u4e1a\u52a1\u903b\u8f91\u4e2d\u8c03\u7528"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u4e00\u822c\u9700\u8981\u83b7\u53d6\u901a\u77e5\u7528\u6237\u7684 openId\uff0c\u53bb\u6570\u636e\u5e93\u4e2d\u67e5\u8be2\u5230 templateId\uff0c\u4e4b\u540e\u7ec4\u88c5\u6d88\u606f\u7136\u540e\u53d1\u9001\u7ed9\u7528\u6237\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'// \u914d\u7f6e\u7684 JSON \u6570\u636e\u4fe1\u606f\u9700\u8981\u770b\u540e\u9762\u7684 \u5fae\u4fe1\u6a21\u677f\u53c2\u6570\u3002\nJSONObject messageData = new JSONObject();\nmessageData.set("thing8", createDataItem("\u670d\u52a1\u5185\u5bb9", projectInfoById.getName()));\nmessageData.set("thing5", createDataItem("\u5907\u6ce8", userNotify.getText()));\nString jsonData = messageData.toJSONString(0);\n\n// \u7ec4\u88c5\u53d1\u9001\u6d88\u606f\u9700\u8981\u7684\u53c2\u6570\nWeChatMsgHelper.send(\n    configProperties,\n    restTemplate,\n    user.getOpenId(),\n    weChatMsg.getTmplId(),\n    "pages/index",\n    jsonData,\n    messageSender\n);\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"\u5c0f\u7a0b\u5e8f\u540e\u53f0\u914d\u7f6e",children:"\u5c0f\u7a0b\u5e8f\u540e\u53f0\u914d\u7f6e"}),"\n",(0,r.jsx)(n.h5,{id:"\u6d88\u606f\u63a8\u9001\u914d\u7f6e",children:"\u6d88\u606f\u63a8\u9001\u914d\u7f6e"}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u5c0f\u7a0b\u5e8f\u540e\u53f0 -> \u7ba1\u7406 -> \u5f00\u53d1\u7ba1\u7406 -> \u6d88\u606f\u63a8\u9001\u4e2d\u914d\u7f6e\u540e\u53f0\u670d\u52a1\u5668\u5730\u5740\u5730\u5740\u4fe1\u606f\u3002"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u6ce8\u610f\uff1a\u5728\u914d\u7f6e\u65f6\u9700\u8981\u53d1\u9001\u9a8c\u8bc1\u5230\u540e\u53f0\u670d\u52a1\u5668\u9a8c\u8bc1\uff0c\u6240\u4ee5\u9700\u8981\u90e8\u7f72\u5230\u516c\u7f51\u53ef\u8bbf\u95ee\u5f97\u73af\u5883\u4e2d\u6d4b\u8bd5\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u5b8c\u6210\u76f8\u5173\u914d\u7f6e\u5982\u4e0b\uff1a"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"\u5fae\u4fe1\u6d88\u606f\u63a8\u9001\u914d\u7f6e",src:t(62382).A+"",width:"1361",height:"514"})}),"\n",(0,r.jsx)(n.h5,{id:"\u6a21\u677f\u6d88\u606f\u914d\u7f6e",children:"\u6a21\u677f\u6d88\u606f\u914d\u7f6e"}),"\n",(0,r.jsx)(n.p,{children:"\u5c0f\u7a0b\u5e8f\u540e\u53f0 -> \u57fa\u7840\u529f\u80fd -> \u8ba2\u9605\u6d88\u606f  -> \u5728\u6211\u7684\u6a21\u677f\u4e2d\u9009\u62e9\u6a21\u677f\u914d\u7f6e\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"\u5fae\u4fe1\u6d88\u606f\u6a21\u677f\u914d\u7f6e",src:t(29121).A+"",width:"1410",height:"572"})}),"\n",(0,r.jsx)(n.h2,{id:"\u6d4b\u8bd5",children:"\u6d4b\u8bd5"}),"\n",(0,r.jsx)(n.h3,{id:"\u624b\u52a8\u7f16\u5199-controller-\u63a5\u53e3",children:"\u624b\u52a8\u7f16\u5199 controller \u63a5\u53e3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'/**\n * \u6d4b\u8bd5\u4f7f\u7528\n * \u6a21\u62df\u6d88\u606f\u63a8\u9001\uff0c\u5199\u6b7b\u6240\u6709\u7684\u53c2\u6570\u4fe1\u606f\uff0c\u5b9e\u9645\u4e2d\u5e94\u8be5\u4ece\u6570\u636e\u5e93\u4e2d\u67e5\u8be2\u5230\u5df2\u7ecf\u8ba2\u9605\u6d88\u606f\u7684\u7528\u6237\u53d1\u9001\u6d88\u606f\u901a\u77e5\u3002\n */\n@GetMapping("/push")\npublic void push() {\n\n    String openid = "ooaER7ctq6G_5CNrs0LE2vR2wCzk";\n    String templateId = "3gMbhH_bFuZlXiaJffCqXlNoqKvJwz_zUSmr-z1jEyo";\n    String page = "/pages/index";\n\n    JSONObject messageData = new JSONObject();\n    messageData.set("thing1", createDataItem("\u516c\u53f8\u540d\u79f0", "\u6d4b\u8bd5\u516c\u53f8"));\n    messageData.set("thing4", createDataItem("\u5730\u5740", "\u5929\u5ead"));\n    messageData.set("name2", createDataItem("\u7528\u6237\u59d3\u540d", "\u6d4b\u8bd5-\u7267\u751f"));\n    messageData.set("phone_number3", createDataItem("\u8054\u7cfb\u65b9\u5f0f", "18198086793"));\n    messageData.set("thing19", createDataItem("\u62a5\u4fee\u539f\u56e0", "\u6d4b\u8bd5\u6d88\u606f\u63a8\u9001"));\n    String jsonData = messageData.toJSONString(0);\n\n    WeChatMsgHelper.send(configProperties, restTemplate, openid, templateId, page, jsonData, messageSender);\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u5b9e\u9645\u4f7f\u7528",children:"\u5b9e\u9645\u4f7f\u7528"}),"\n",(0,r.jsx)(n.p,{children:"\u5b9e\u9645\u4f7f\u7528\u9700\u8981\u5728\u4e1a\u52a1\u4ee3\u7801\u903b\u8f91\u4e2d\u8c03\u7528\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u6548\u679c\u9884\u89c8",children:"\u6548\u679c\u9884\u89c8"}),"\n",(0,r.jsx)(n.p,{children:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u63a5\u6536\u5982\u4e0b\uff1a"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u63a5\u6536",src:t(56408).A+"",width:"1200",height:"2652"})})]})}function g(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},62382:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/img3-f3ed982b34d412a323323c4153e9cde6.png"},29121:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/img4-94412200e0973b30f71b1d8324a61a43.png"},56408:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/img5-8e2d06ef425a4ed6ef4ec7687c0b76c2.png"},47251:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/img6-73d9b6e549c958a2d307347a87eb8784.png"},89999:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>l});var s=t(58101);const r={},a=s.createContext(r);function i(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(a.Provider,{value:n},e.children)}},18490:e=>{e.exports=JSON.parse('{"permalink":"/blog/wechatminiapp-msg-push","editUrl":"https://github.com/yuluo-yx/blog/edit/master/blog/wehchat-app/\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u63a8\u9001.md","source":"@site/blog/wehchat-app/\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u63a8\u9001.md","title":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u63a8\u9001","description":"\u9700\u6c42\u80cc\u666f","date":"2024-10-10T22:41:01.000Z","tags":[{"inline":true,"label":"Unipp","permalink":"/blog/tags/unipp"},{"inline":true,"label":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f","permalink":"/blog/tags/\u5fae\u4fe1\u5c0f\u7a0b\u5e8f"},{"inline":true,"label":"Vue3","permalink":"/blog/tags/vue-3"}],"readingTime":6.6,"hasTruncateMarker":true,"authors":[{"name":"\u7267\u751f","title":"Java & go developer","url":"https://github.com/yuluo-yx","email":"yuluo08290126@gmail.com","socials":{"x":"https://x.com/yuluo","github":"https://github.com/yuluo-yx"},"imageURL":"https://kuizuo.cn/img/logo.png","key":"yuluo","page":null}],"frontMatter":{"slug":"wechatminiapp-msg-push","title":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u6d88\u606f\u63a8\u9001","date":"2024-10-10T22:41:01.000Z","authors":"yuluo","tags":["Unipp","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f","Vue3"],"keywords":["msg","Unipp","Vue3","\u5fae\u4fe1\u5c0f\u7a0b\u5e8f"]},"unlisted":false,"prevItem":{"title":"\u968f\u7b14 2024/11/24","permalink":"/blog/write-somethings"},"nextItem":{"title":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u767b\u5f55\u548c\u83b7\u53d6\u4fe1\u606f\u529f\u80fd\u8bb0\u5f55","permalink":"/blog/wechatminiapp-login-get-use-info"}}')}}]);