---
slug: vllm-sr-understand
title: VSR é¡¹ç›®è§£æ
date: 2025-10-18 23:36:16
authors: yuluo
tags: [LLM, Gateway, Go]
keywords: [LLM, Gateway, Go]
image: /img/ai/mom/3.png
---

<!-- truncate -->

æ‰¿ä¸Šæ–‡ [Vllm Semantic-router MoM æ¶æ„](https://yuluo-yx.github.io/blog/vllm-sr-mom)ï¼Œç†è§£ä¸‹ VSR è¯­ä¹‰è·¯ç”±é¡¹ç›®æ•´ä½“éƒ¨åˆ†ã€‚

## æœ¯è¯­è§£é‡Š

> Ok, å¼€å§‹ä¹‹å‰ã€‚å…ˆå¯¹ä¸€äº›ä¸“ä¸šæœ¯è¯­æ‰«ç›²ï¼Œä»¥å…é€ æˆç†è§£é”™è¯¯ã€‚

- Candle Hugging Face çš„æœºå™¨å­¦ä¹ ï¼ˆMLï¼‰æ¡†æ¶ï¼Œç”± Rust ç¼–å†™ï¼›
- FFI (Foreign Function Interface) Candle é€šè¿‡ FFI æš´éœ²ç»™ Go è°ƒç”¨ï¼›
- decoder-onlyï¼šç”Ÿæˆæ¨¡å‹ï¼ŒGPT Qwen ç­‰ã€‚
- encoder-onlyï¼šï¼ˆæœ‰æ—¶ä¹Ÿç§°è¡¨å¾æ¨¡å‹ï¼‰è¾“å‡ºæ˜¯ä¸€ä¸ª embedding å‘é‡ï¼›
- BERT æ¨¡å‹ï¼šè‡ªç„¶è¯­è¨€ç†è§£æ¨¡å‹ï¼Œç†è§£è¯­ä¹‰ï¼›
- ModernBERT æ¨¡å‹ï¼šæ›´å¤§ token çš„ BERT æ¨¡å‹ï¼ŒåŒæ³¨æ„åŠ›æœºåˆ¶ï¼›
- LoRA ï¼š(Low-Rank Adaptation) å¾®è°ƒæ¨¡å‹ç”¨ï¼ŒåŠ é€Ÿæ¨¡å‹å¾®è°ƒï¼Œæ¨ç†é˜¶æ®µä¸å­˜åœ¨ï¼›
- Jailbreak Detectionï¼šè¶Šç‹±æ£€æµ‹ã€‚é˜²æ­¢æ¶æ„ prompt æ”»å‡»ï¼Œåœ¨è¯·æ±‚åˆ°è¾¾ LLM ä¹‹å‰è¿›è¡Œå®‰å…¨è¿‡æ»¤ï¼›
- Intent Classificationï¼šæ„å›¾åˆ†ç±»ï¼›
- PII æ£€æµ‹ï¼šä¸ªäººèº«ä»½ä¿¡æ¯æ£€æµ‹ï¼›
- Fine-tuning ï¼šå¾®è°ƒï¼Œä½¿ç”¨é¢„è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå°‘é‡æ ‡æ³¨æ•°æ®ï¼›
- Pre-Traingï¼šé¢„è®­ç»ƒï¼›æµ·é‡æ•°æ®ï¼Œå¤§é‡ GPU èµ„æºä» 0 è®­ç»ƒã€‚

ä¸€äº›æœ¯è¯­å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/14063328673

## å·¥ä½œæµç¨‹

![image-20251018230818243](/img/ai/mom/3.png)

VSR ç”±ä¸‰ç§è¯­è¨€å¼‚æ„ç»„åˆè€Œæˆï¼Œå…¶ä¸­ Golang è´Ÿè´£æµé‡æ¥å…¥å’Œè½¬å‘ï¼ŒRust è´Ÿè´£è°ƒç”¨æ¨¡å‹å¾—å‡ºç»“æœï¼ŒPython è´Ÿè´£è®­ç»ƒå’Œå¾®è°ƒ BERT æ¨¡å‹ã€‚

## æ•´ä½“æ¶æ„

![VSR Arch](https://yuluo-yx.github.io/assets/images/2-d82c8db20a2548352f67777c38d8d96b.png)

 ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒVSR ä¸»è¦å›´ç»•é«˜æ€§èƒ½çš„ Rust åˆ†ç±»æ„å»ºã€‚

å…¶ä»–æ¨¡å—ä¸»è¦èŒè´£ä¸ºï¼š

Pythonï¼š`src/training`æ¨¡å‹è®­ç»ƒè„šæœ¬ï¼Œè´Ÿè´£å¾®è°ƒå’Œè®­ç»ƒ BERT æ¨¡å‹ï¼›

Golangï¼šrouter è´Ÿè´£è·¯ç”±ç”¨æˆ·è¯·æ±‚æµé‡ï¼Œè°ƒç”¨ candle-bindingï¼›

Rustï¼šcandle-binding åŠ è½½è®­ç»ƒå®Œæˆçš„æ¨¡å‹ï¼Œè¯­ä¹‰åˆ†æ•°è®¡ç®—ï¼Œæ–‡æœ¬åˆ†ç±»ï¼Œè¿”å›ç»“æœç»™ Go clientï¼›

Envoyï¼šè°ƒç”¨ Backend LLMã€‚

## Candle-binding 

VSR çš„å¤§è„‘éƒ¨åˆ†ã€‚ML æ¨ç†å¼•æ“ç»‘å®šã€‚æä¾›äº† rust candle çš„æœºå™¨å­¦ä¹ å’Œæ¨¡å‹æ¨ç†èƒ½åŠ›ï¼Œå¹¶é€šè¿‡ FFIï¼ˆForeign Function Interfaceï¼‰æš´éœ²ç»™ Go ä½¿ç”¨ã€‚

```markdown
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Go Application Layer                   â”‚
â”‚         (semantic-router.go - CGO Bindings)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ FFI (C ABI)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Rust Native Library                        â”‚
â”‚        (libcandle_semantic_router.dylib/.so)            â”‚
â”‚                                                         â”‚
â”‚  â”œâ”€â”€ lib.rs           - ä¸»å…¥å£å’Œç›¸ä¼¼åº¦è®¡ç®—                 â”‚
â”‚  â”œâ”€â”€ bert_official.rs - å®˜æ–¹ BERT åˆ†ç±»å™¨                  â”‚
â”‚  â”œâ”€â”€ modernbert.rs    - ModernBERT å®ç°                  â”‚
â”‚  â””â”€â”€ unified_classifier.rs - ç»Ÿä¸€åˆ†ç±»å™¨ (LoRAæ”¯æŒ)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Candle ML Framework (Hugging Face)            â”‚
â”‚     - Rust åŸç”Ÿ ML æ¡†æ¶ (ç±»ä¼¼ PyTorch)                    â”‚
â”‚     - GPU/CPU åŠ é€Ÿæ”¯æŒ                                   â”‚
â”‚     - BERT/ModernBERT æ¨¡å‹å®ç°                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Train

VSR çš„è®­ç»ƒæ¨¡å—ã€‚candle æœ€ç»ˆè°ƒç”¨çš„æ¨¡å‹æ¥æºã€‚ä½¿ç”¨çš„æ•°æ®æ¥è‡ª HF çš„å…¬å¼€æ•°æ®é›†ã€‚

```markdown
Training
  â”‚
  â”œâ”€ è¾“å…¥: æ•°æ®é›† + BERT åŸºç¡€æ¨¡å‹
  â”‚
  â”œâ”€ è®­ç»ƒ: LoRA å¾®è°ƒ (1% å‚æ•°)
  â”‚   â””â”€ ä¼˜åŠ¿: å¿«é€Ÿã€çœå†…å­˜ã€æ•ˆæœå¥½
  â”‚
  â””â”€ è¾“å‡º:
      â”œâ”€ LoRA é€‚é…å™¨ (1-2MB) - ä¸­é—´äº§ç‰©
      â”‚   â””â”€ adapter_model.safetensors
      â”‚   â””â”€ é€šå¸¸è¢«ä¸‹ä¸€æ­¥è¦†ç›–æˆ–åˆ é™¤
      â”‚
      â””â”€ å®Œæ•´åˆå¹¶æ¨¡å‹ (440MB) 
          â””â”€ merge_and_unload() è‡ªåŠ¨æ‰§è¡Œåˆå¹¶
          â””â”€ Rust/Candle ç”¨
              â””â”€ Go æœåŠ¡è°ƒç”¨
                  â””â”€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

æ ¸å¿ƒæµç¨‹: LoRA æ¨¡å‹è¢«è‡ªåŠ¨åˆå¹¶
LoRA è®­ç»ƒ â†’ merge_and_unload() â†’ model.safetensors â†’ Candle åŠ è½½ â†’ æ¨ç†
```

### LoRA å¾®è°ƒ

```markdown
W_new = W_pretrained + B Ã— A
#       â†‘              â†‘
#    å†»ç»“ä¸åŠ¨      åªè®­ç»ƒè¿™ä¸¤ä¸ªå°çŸ©é˜µ

# å‚æ•°å¯¹æ¯”ï¼š
# å®Œæ•´å¾®è°ƒ: è®­ç»ƒ 110M å‚æ•°
# LoRA å¾®è°ƒ: è®­ç»ƒ 1.2M å‚æ•° (â†“ 99%)

# æ•ˆæœï¼š
# - é€Ÿåº¦å¿« 3-5 å€
# - å†…å­˜çœ 67%
# - æ€§èƒ½å‡ ä¹ç›¸åŒ (99.5%)
```

## Go 

é›†æˆ Envoy ExtProc å¤„ç†è¾“å…¥æµé‡ï¼Œå¾€åè°ƒç”¨ candleã€‚æ”¯æŒä»»ä½•å…¼å®¹ OpenAI API çš„ llm åç«¯æœåŠ¡ã€‚

```markdown
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®Œæ•´è¯·æ±‚å¤„ç†æµç¨‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¯·æ±‚: POST /v1/chat/completions
{
  "model": "gpt-3.5-turbo",
  "messages": [{"role": "user", "content": "å¸®æˆ‘è§£è¿™é“å¾®ç§¯åˆ†é¢˜"}]
}
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£  Envoy Proxy (ç«¯å£ 8801)                                            â”‚
â”‚    - æ¥æ”¶ HTTP è¯·æ±‚                                                    â”‚
â”‚    - æå–è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“ gRPC è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£  ExtProc (Go æœåŠ¡, ç«¯å£ 50051)                                      â”‚
â”‚    pkg/extproc/processor.go                                           â”‚
â”‚                                                                        â”‚
â”‚    Process() å¤„ç†æµ:                                                   â”‚
â”‚    â”œâ”€ RequestHeaders  â†’ handleRequestHeaders()                        â”‚
â”‚    â”œâ”€ RequestBody     â†’ handleRequestBody() â­ ä¸»è¦å¤„ç†                â”‚
â”‚    â”œâ”€ ResponseHeaders â†’ handleResponseHeaders()                       â”‚
â”‚    â””â”€ ResponseBody    â†’ handleResponseBody()                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£  è¯·æ±‚ä½“å¤„ç†: handleRequestBody()                                    â”‚
â”‚    pkg/extproc/request_handler.go                                     â”‚
â”‚                                                                        â”‚
â”‚    æ­¥éª¤:                                                               â”‚
â”‚    â”œâ”€ 1. è§£æ OpenAI è¯·æ±‚ä½“                                           â”‚
â”‚    â”œâ”€ 2. æå–ç”¨æˆ·æ¶ˆæ¯å†…å®¹                                             â”‚
â”‚    â”œâ”€ 3. æ£€æŸ¥è¯­ä¹‰ç¼“å­˜ (å¯é€‰)                                          â”‚
â”‚    â”œâ”€ 4. è°ƒç”¨åˆ†ç±»å™¨ â¬‡ï¸                                                â”‚
â”‚    â”œâ”€ 5. è°ƒç”¨ PII æ£€æµ‹ â¬‡ï¸                                              â”‚
â”‚    â”œâ”€ 6. è°ƒç”¨è¶Šç‹±æ£€æµ‹ â¬‡ï¸                                               â”‚
â”‚    â”œâ”€ 7. è·¯ç”±å†³ç­–                                                     â”‚
â”‚    â””â”€ 8. ä¿®æ”¹è¯·æ±‚å¤´/ä½“                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                        â†“                     â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£  æ„å›¾åˆ†ç±»      â”‚  â”‚ 5ï¸âƒ£  PII æ£€æµ‹      â”‚  â”‚ 6ï¸âƒ£  è¶Šç‹±æ£€æµ‹       â”‚  â”‚å·¥å…· â”‚
â”‚ (Classifier)     â”‚  â”‚ (PIIChecker)     â”‚  â”‚ (PromptGuard)     â”‚  â”‚åŒ¹é… â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚                     â”‚
        â†“ Go è°ƒç”¨                â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ candle_binding   â”‚  â”‚ candle_binding   â”‚  â”‚ candle_binding    â”‚
â”‚ (CGO)            â”‚  â”‚ (CGO)            â”‚  â”‚ (CGO)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚                     â”‚
        â†“ FFI è°ƒç”¨               â†“                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rust Candle      â”‚  â”‚ Rust Candle      â”‚  â”‚ Rust Candle       â”‚
â”‚ Intent Model     â”‚  â”‚ PII Model        â”‚  â”‚ Jailbreak Model   â”‚
â”‚ (BERT æ¨ç†)      â”‚  â”‚ (Token åˆ†ç±»)     â”‚  â”‚ (BERT æ¨ç†)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚                     â”‚
        â”‚ è¿”å›ç»“æœ                â”‚                     â”‚
        â”‚ Category: "math"       â”‚ HasPII: false       â”‚ IsJailbreak: false
        â”‚ Confidence: 0.95       â”‚ Confidence: 0.98    â”‚ Confidence: 0.92
        â”‚                        â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                    â†“
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚ 7ï¸âƒ£  è·¯ç”±å†³ç­–å¼•æ“      â”‚
                                                    â”‚                      â”‚
                                                    â”‚ è§„åˆ™:                â”‚
                                                    â”‚ â”œâ”€ IsJailbreak?      â”‚
                                                    â”‚ â”‚   â””â”€ Block (403)   â”‚
                                                    â”‚ â”œâ”€ HasPII?           â”‚
                                                    â”‚ â”‚   â””â”€ Log + å¯é€‰é˜»æ­¢â”‚
                                                    â”‚ â””â”€ Category + Conf?  â”‚
                                                    â”‚     â””â”€ Select Model  â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                    â”‚
                                                                    â†“
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ 8ï¸âƒ£  ä¿®æ”¹è¯·æ±‚                  â”‚
                                            â”‚                              â”‚
                                            â”‚ æ·»åŠ è¯·æ±‚å¤´:                   â”‚
                                            â”‚ - x-selected-model: math-7b  â”‚
                                            â”‚ - x-category: mathematics    â”‚
                                            â”‚ - x-confidence: 0.95         â”‚
                                            â”‚ - x-gateway-destination:     â”‚
                                            â”‚   http://math-llm:8000       â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                    â”‚
                                                                    â†“
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ 9ï¸âƒ£  è¿”å› gRPC å“åº”ç»™ Envoy   â”‚
                                            â”‚                              â”‚
                                            â”‚ ProcessingResponse {         â”‚
                                            â”‚   HeaderMutation,            â”‚
                                            â”‚   BodyMutation,              â”‚
                                            â”‚   Status: CONTINUE           â”‚
                                            â”‚ }                            â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                    â”‚
                                                                    â†“
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ ğŸ”Ÿ  Envoy è·¯ç”±åˆ°åç«¯ vLLM     â”‚
                                            â”‚                              â”‚
                                            â”‚ æ ¹æ® x-gateway-destination:  â”‚
                                            â”‚ http://math-llm:8000         â”‚
                                            â”‚                              â”‚
                                            â”‚ è½¬å‘è¯·æ±‚åˆ°ä¸“ç”¨æ¨¡å‹            â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                    â”‚
                                                                    â†“
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ 1ï¸âƒ£1ï¸âƒ£  vLLM åç«¯ (math-llm)    â”‚
                                            â”‚                              â”‚
                                            â”‚ æ¥æ”¶è¯·æ±‚å¹¶ç”Ÿæˆå›å¤            â”‚
                                            â”‚ Model: meta-llama/Llama-7b   â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                    â”‚
                                                                    â†“
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ 1ï¸âƒ£2ï¸âƒ£  å“åº”è¿”å›ç»™ç”¨æˆ·          â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç®€åŒ–å›¾

```markdown
ç”¨æˆ·è¯·æ±‚ â†’ Envoy (8801) â†’ ExtProc (Go, 50051)
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
                æ„å›¾åˆ†ç±»         PIIæ£€æµ‹         è¶Šç‹±æ£€æµ‹
                    â”‚               â”‚               â”‚
                   CGO             CGO             CGO
                    â”‚               â”‚               â”‚
                Rust Candle     Rust Candle     Rust Candle
                    â”‚               â”‚               â”‚
              Category: "math"  HasPII: false  IsJailbreak: false
              Confidence: 0.95  Entities: []   Confidence: 0.92
                    â”‚               â”‚               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                            è·¯ç”±å†³ç­–å¼•æ“
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
              IsJailbreak?                    Category?
                    â”‚                               â”‚
                  Block                       Select Model
                (403)                         (math-llama-7b)
                                                    â”‚
                                        Set Header:
                                        x-gateway-destination:
                                        http://math-llm:8000
                                                    â”‚
                                        Return to Envoy
                                                    â”‚
                                        Route to Backend
                                        (math-llm:8000)
```

## å¯è§‚æµ‹

åŸºäº OT + Prometheus + Grafana + Jaeger ã€‚é€šè¿‡ `/metrics` å¯¼å‡ºè§‚æµ‹æ•°æ®ã€‚ÃŸ

## Config 

> VSR æä¾›äº†å……è¶³çš„é…ç½®é¡¹ï¼Œé…ç½®å„ä¸ªåŸºæœ¬å±æ€§ã€‚æœ‰ä¸‹é¢å‡ ç§ç±»å‹ï¼š

 bert æ¨¡å‹é…ç½®

åˆ†ç±»å™¨é…ç½®

- æ„å›¾åˆ†ç±»
- PII æ£€æµ‹
- è¶Šç‹±æ£€æµ‹

æ¨ç†æ¨¡å¼é…ç½®

ç±»åˆ«æ¨¡å¼ä¸è¯„åˆ†

è¯­ä¹‰ç¼“å­˜é…ç½®

å¯è§‚æµ‹é…ç½®
